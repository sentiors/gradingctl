#!/bin/bash

SERVER_URL="http://100.70.220.18:8001"
#ACTIVE_LAB_FILE="/tmp/active_lab"
#ACTIVE_LAB_FILE="$HOME/.grading_active_lab"
ACTIVE_LAB_FILE="$HOME/.active_lab"

# Warna ANSI
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

function register() {
    echo -n "Nama Lengkap: "
    read name
    name=${name^^}

# --- Input Email (Clean Loop) ---
    while true; do
        echo -ne "Email (@gmail.com): "
        read email
        email=$(echo "$email" | tr -d ' ' | tr '[:upper:]' '[:lower:]')

        if [[ "$email" =~ ^[a-z0-9._%+-]+@gmail\.com$ ]]; then
            break
        else
            # 1. Hapus input yang salah tadi
            tput cuu1; tput el
            echo "Email (@gmail.com): "

            # 2. Cetak pesan error di bawahnya
            echo -e "\033[31mFormat salah! Gunakan @gmail.com\033[0m"

            # 3. Tunggu sebentar, lalu hapus pesan error dan balik ke atas
            sleep 1
            tput cuu1; tput el # Hapus baris error
            tput cuu1; tput el # Hapus baris label buat ditimpa ulang oleh loop
        fi
    done

    # --- Input No Telp (Clean Loop) ---
    while true; do
        echo -ne "No Telp (Mulai 62): "
        read phone
        phone=$(echo "$phone" | tr -d ' ')

        if [[ "$phone" =~ ^62[0-9]+$ ]]; then
            break
        else
            tput cuu1; tput el
            echo "No Telp (Mulai 62): "
            echo -e "\033[31mFormat salah! Harus mulai dengan 62.\033[0m"
            sleep 1
            tput cuu1; tput el
            tput cuu1; tput el
        fi
    done

    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo ""

# --- Pilihan Kelompok ---
    GROUPS_JSON=$(curl -s "$SERVER_URL/get_groups")
    mapfile -t group_array < <(echo "$GROUPS_JSON" | jq -r '.groups[]')

    echo "Pilih Kelompok:"
    for i in "${!group_array[@]}"; do echo "$((i+1)). ${group_array[$i]}"; done
    echo -n "Nomor: "; read g_idx
    selected_group="${group_array[$((g_idx-1))]}"

    # LOGIKA PEMBERSIHAN KELOMPOK
    # Hitung: jumlah array + 2 (baris "Pilih Kelompok" dan baris "Nomor")
    lines_to_clear_g=$((${#group_array[@]} + 2))
    for ((i=1; i<=lines_to_clear_g; i++)); do tput cuu1; tput el; done
    echo "Kelompok: $selected_group"

    # --- Pilihan Kelas ---
    CLASSES_JSON=$(curl -s "$SERVER_URL/get_classes")
    mapfile -t class_array < <(echo "$CLASSES_JSON" | jq -r '.classes[]')

    echo "Pilih Kelas:"
    for i in "${!class_array[@]}"; do echo "$((i+1)). ${class_array[$i]}"; done
    echo -n "Nomor: "; read c_idx
    classname="${class_array[$((c_idx-1))]}"

    # LOGIKA PEMBERSIHAN KELAS
    # Hitung: jumlah array + 2
    lines_to_clear_c=$((${#class_array[@]} + 2))
    for ((i=1; i<=lines_to_clear_c; i++)); do tput cuu1; tput el; done
    echo "Kelas: $classname"

    # Kirim Data
    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
        -d "{\"username\":\"$username\",\"password\":\"$password\",\"name\":\"$name\",\"email\":\"$email\",\"phone\":\"$phone\",\"class_name\":\"$classname\",\"group_name\":\"$selected_group\"}" \
        $SERVER_URL/register)

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" ]]; then
        echo -e "\033[31mError: $ERROR\033[0m"
    else
        echo -e "\033[32mRegistrasi Berhasil!\033[0m"
    fi
}

function login() {
    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
    -d "{\"username\": \"$username\", \"password\": \"$password\"}" \
    $SERVER_URL/login)

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    TOKEN=$(echo "$RESPONSE" | jq -r '.token')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        if [[ "$ERROR" == "User not exist, please register first (gradingctl register)" ]]; then
            echo -e "${YELLOW}Please register first using: gradingctl register${NC}"
        fi
        exit 1
    elif [[ $TOKEN == "null" || -z $TOKEN ]]; then
        echo -e "${RED}Login gagal!${NC}"
        exit 1
    else
        echo $TOKEN > ~/.nusactl_token
        echo -e "${GREEN}Login berhasil!${NC}"
    fi
}


function start_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    if [[ -z "$TOKEN" ]]; then
        echo -e "${RED}Error: Token tidak ditemukan. Silakan login.${NC}"
        exit 1
    fi

    LAB_ID=$1
    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Error: Lab ID dibutuhkan.${NC}"
        exit 1
    fi

    # Kirim request ke server
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/start-lab")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Simpan lab yang aktif
    echo "$LAB_ID" > "$ACTIVE_LAB_FILE"
    echo -e "${GREEN}[-] Starting lab -> $LAB_ID${NC}"
    echo -e "${GREEN}[✓] Lab $LAB_ID dimulai${NC}"

    START_FILE="$HOME/.grading_start_${LAB_ID}"
    date +%s > "$START_FILE"

    # Handle opsi -s dan -f
    if [[ "$2" == "-s" ]]; then
        show_simplified_scheme "$LAB_ID"
    elif [[ "$2" == "-f" ]]; then
        save_scheme_to_file "$LAB_ID"
    fi
}

function show_simplified_scheme() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil deskripsi skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme-description?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Tampilkan deskripsi skema yang disederhanakan
    echo -e "${NC}Lab: $LAB_ID${NC}"
    echo -e "${NC}----------------${NC}"
    echo ""
    echo -e "${NC}Tasks:${NC}"
    echo "$RESPONSE" | jq -r '.criteria[] | "- \(.description)"'
}

function save_scheme_to_file() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Ekstrak hanya daftar task (criteria) dari skema
    TASKS=$(echo "$RESPONSE" | jq -c '.scheme.criteria[] | {description: .description}')

    # Simpan daftar task ke file JSON
    SCHEME_FILE="/tmp/${LAB_ID}_scheme.json"
    echo "$TASKS" | jq -s '.' > "$SCHEME_FILE"

    # Tampilkan lokasi file
    echo -e "${GREEN}Scheme saved to: $SCHEME_FILE${NC}"
}

function escape_json() {
    # Escape karakter kontrol dan karakter khusus dalam string JSON
    echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\x00/\\u0000/g' -e 's/\x01/\\u0001/g' \
    -e 's/\x02/\\u0002/g' -e 's/\x03/\\u0003/g' -e 's/\x04/\\u0004/g' -e 's/\x05/\\u0005/g' \
    -e 's/\x06/\\u0006/g' -e 's/\x07/\\u0007/g' -e 's/\x08/\\b/g' -e 's/\x09/\\t/g' \
    -e 's/\x0A/\\n/g' -e 's/\x0B/\\u000B/g' -e 's/\x0C/\\f/g' -e 's/\x0D/\\r/g' \
    -e 's/\x0E/\\u000E/g' -e 's/\x0F/\\u000F/g' -e 's/\x10/\\u0010/g' -e 's/\x11/\\u0011/g' \
    -e 's/\x12/\\u0012/g' -e 's/\x13/\\u0013/g' -e 's/\x14/\\u0014/g' -e 's/\x15/\\u0015/g' \
    -e 's/\x16/\\u0016/g' -e 's/\x17/\\u0017/g' -e 's/\x18/\\u0018/g' -e 's/\x19/\\u0019/g' \
    -e 's/\x1A/\\u001A/g' -e 's/\x1B/\\u001B/g' -e 's/\x1C/\\u001C/g' -e 's/\x1D/\\u001D/g' \
    -e 's/\x1E/\\u001E/g' -e 's/\x1F/\\u001F/g'
}

# ========= HELPER DINAMIS: kelompok / kelas -> X & range IP =========

determine_dynamic_variables() {
    local IDENTITY=$1    # contoh: "kelompok5-sija1", "kelompok2-sija2", "kelompokx-sijax"

    # Lowercase biar aman
    IDENTITY=$(echo "$IDENTITY" | tr '[:upper:]' '[:lower:]')

    # --- CASE KHUSUS: GURU (kelompokx-sijax) ---
    # Menggunakan baris "Guru" dari tabel di dokumen:
    # - Internal: X = 1  => 192.30.1.0/24 dan 192.70.1.0/24
    # - Router external: 172.20.10.2-4
    # - Floating IP: 172.20.10.59-68
    if [[ "$IDENTITY" == "kelompokx-sijax" ]]; then
        CLASS_TYPE="x"
        GROUP_NUM="x"

        EXPECTED_INTERNAL_OCTET=1
        EXPECTED_LB_OCTET=1

        EXPECTED_EXT_START=2
        EXPECTED_EXT_END=4

        FIP_START=59
        FIP_END=68

        TARGET_INTERNAL_NET="192.30.${EXPECTED_INTERNAL_OCTET}.0"
        TARGET_LB_NET="192.70.${EXPECTED_LB_OCTET}.0"

        RANGE_START_INT=$EXPECTED_EXT_START
        RANGE_END_INT=$EXPECTED_EXT_END

        TARGET_EXT_RANGE_START="172.20.10.${EXPECTED_EXT_START}"
        TARGET_EXT_RANGE_END="172.20.10.${EXPECTED_EXT_END}"

        FIP_RANGE_START_INT=$FIP_START
        FIP_RANGE_END_INT=$FIP_END

        EXPECTED_SUFFIX="kelompokx-sijax"

        export CLASS_TYPE GROUP_NUM \
               TARGET_INTERNAL_NET TARGET_LB_NET \
               RANGE_START_INT RANGE_END_INT \
               TARGET_EXT_RANGE_START TARGET_EXT_RANGE_END \
               FIP_RANGE_START_INT FIP_RANGE_END_INT \
               EXPECTED_SUFFIX
        return 0
    fi

    # --- Deteksi kelas: sija1 / sija2 ---
    if [[ "$IDENTITY" == *"sija1"* ]]; then
        CLASS_TYPE=1
    elif [[ "$IDENTITY" == *"sija2"* ]]; then
        CLASS_TYPE=2
    elif [[ "$IDENTITY" == *"sija3"* ]]; then
        CLASS_TYPE=3
    else
        echo "Error: Kelas tidak dikenali di IDENTITY=$IDENTITY (butuh sija1/sija2/sijax)" >&2
        return 1
    fi

    # --- Deteksi nomor kelompok: kelompok1..kelompok9 ---
    if [[ "$IDENTITY" =~ kelompok([0-9]+) ]]; then
        GROUP_NUM=${BASH_REMATCH[1]}
    else
        echo "Error: Nomor kelompok tidak ditemukan di IDENTITY=$IDENTITY" >&2
        return 1
    fi

    # Pastikan GROUP_NUM angka 1..9
    if ! [[ "$GROUP_NUM" =~ ^[1-9]$ ]]; then
        echo "Error: GROUP_NUM=$GROUP_NUM tidak valid (harus 1..9 atau x)" >&2
        return 1
    fi

    # --- Logika matematis (sesuai tabel) ---

    # 1) Internal network 192.30.X.0/24
    # SIJA 1: X = group + 1
    # SIJA 2: X = group + 10
    if [[ "$CLASS_TYPE" -eq 1 ]]; then
        EXPECTED_INTERNAL_OCTET=$((GROUP_NUM + 1))
    else
        EXPECTED_INTERNAL_OCTET=$((GROUP_NUM + 10))
    else
        EXPECTED_INTERNAL_OCTET=$((GROUP_NUM + 20))
    fi

    # Subnet HAProxy 192.70.X.0/24 pakai X yang sama
    EXPECTED_LB_OCTET=$EXPECTED_INTERNAL_OCTET

    # 2) External router range (172.20.10.x), tiap kelompok dapat 3 IP
    # SIJA 1: start = 5  + (group-1)*3
    # SIJA 2: start = 32 + (group-1)*3
    if [[ "$CLASS_TYPE" -eq 1 ]]; then
        EXPECTED_EXT_START=$((5  + (GROUP_NUM - 1) * 3))
    else
        EXPECTED_EXT_START=$((32 + (GROUP_NUM - 1) * 3))
    else
        EXPECTED_EXT_START=$((60 + (GROUP_NUM - 1) * 3))
    fi
    EXPECTED_EXT_END=$((EXPECTED_EXT_START + 2))

    # 3) Floating IP range (172.20.10.x) – dari tabel di dokumen
    if [[ "$CLASS_TYPE" -eq 1 ]]; then
        case $GROUP_NUM in
          1) FIP_START=69  ; FIP_END=78  ;;
          2) FIP_START=79  ; FIP_END=88  ;;
          3) FIP_START=89  ; FIP_END=98  ;;
          4) FIP_START=99  ; FIP_END=108 ;;
          5) FIP_START=109 ; FIP_END=118 ;;
          6) FIP_START=119 ; FIP_END=128 ;;
          7) FIP_START=129 ; FIP_END=138 ;;
          8) FIP_START=139 ; FIP_END=148 ;;
          9) FIP_START=149 ; FIP_END=158 ;;
        esac
    elif [[ "$CLASS_TYPE" -eq 2 ]]; then
        case $GROUP_NUM in
          1) FIP_START=159 ; FIP_END=168 ;;
          2) FIP_START=169 ; FIP_END=178 ;;
          3) FIP_START=179 ; FIP_END=188 ;;
          4) FIP_START=189 ; FIP_END=198 ;;
          5) FIP_START=199 ; FIP_END=208 ;;
          6) FIP_START=209 ; FIP_END=218 ;;
          7) FIP_START=219 ; FIP_END=228 ;;
          8) FIP_START=229 ; FIP_END=238 ;;
          9) FIP_START=239 ; FIP_END=248 ;;
        esac
    elif [[ "$CLASS_TYPE" -eq 3 ]]; then
        case $GROUP_NUM in
          1) FIP_START=250 ; FIP_END=259 ;;
          2) FIP_START=260 ; FIP_END=269 ;;
          3) FIP_START=270 ; FIP_END=279 ;;
        esac
    fi

    # --- Bentuk variabel final ---

    TARGET_INTERNAL_NET="192.30.${EXPECTED_INTERNAL_OCTET}.0"
    TARGET_LB_NET="192.70.${EXPECTED_LB_OCTET}.0"

    RANGE_START_INT=$EXPECTED_EXT_START
    RANGE_END_INT=$EXPECTED_EXT_END

    TARGET_EXT_RANGE_START="172.20.10.${EXPECTED_EXT_START}"
    TARGET_EXT_RANGE_END="172.20.10.${EXPECTED_EXT_END}"

    FIP_RANGE_START_INT=$FIP_START
    FIP_RANGE_END_INT=$FIP_END

    EXPECTED_SUFFIX="kelompok${GROUP_NUM}-sija${CLASS_TYPE}"

    export CLASS_TYPE GROUP_NUM \
           TARGET_INTERNAL_NET TARGET_LB_NET \
           RANGE_START_INT RANGE_END_INT \
           TARGET_EXT_RANGE_START TARGET_EXT_RANGE_END \
           FIP_RANGE_START_INT FIP_RANGE_END_INT \
           EXPECTED_SUFFIX
}

function grade_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    LAB_ID=$1

    if [[ ! -f "$ACTIVE_LAB_FILE" || $(cat "$ACTIVE_LAB_FILE") != "$LAB_ID" ]]; then
        echo -e "${YELLOW}[!] Warning: local active_lab mismatch, you may need to run 'gradingctl start $LAB_ID'${NC}"
    fi

    CLASS_NAME=$(echo "$TOKEN" | cut -d'-' -f4)

    SCHEME_RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    SCHEME=$(echo "$SCHEME_RESPONSE" | jq -c '.scheme')
    if [[ -z "$SCHEME" || "$SCHEME" == "null" ]]; then
        echo "Error: Failed to fetch scheme for lab $LAB_ID"
        exit 1
    fi

    # ================== IDENTITAS + MAPPING DINAMIS ==================
    USER_IDENTITY=$(echo "$TOKEN" \
        | tr '[:upper:]' '[:lower:]' \
        | grep -o 'kelompok[0-9x-]*sija[12x]' \
        | head -1)

    if [[ -z "$USER_IDENTITY" ]]; then
        CURRENT_OS_USER=$(whoami)
        USER_IDENTITY=$(echo "$CURRENT_OS_USER" | tr '[:upper:]' '[:lower:]' | grep -o 'kelompok[0-9x-]*sija[12x]' | head -1)
    fi

    if [[ -z "$USER_IDENTITY" ]]; then
        USER_IDENTITY="kelompokx-sijax"
    fi

    determine_dynamic_variables "$USER_IDENTITY" || {
        echo -e "${RED}Error: gagal init variabel dinamis untuk $USER_IDENTITY${NC}"
        exit 1
    }

    declare -A DATA

    while IFS= read -r criterion; do
        TYPE=$(echo "$criterion" | jq -r '.type')
        KEY=$(echo "$criterion" | jq -r '.key')

#        echo "=== RAW SCHEME ==="
#        echo "$SCHEME" | jq .
#        echo "=== RAW CRITERIA STREAM ==="
#        echo "$SCHEME" | jq -c '.criteria[]'

#        echo "DEBUG CRITERION: TYPE=$TYPE KEY=$KEY"

        case $TYPE in
            command)
                CMD_TEMPLATE=$(echo "$criterion" | jq -r '.command')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')

                # ===================== QUIZ 001-1 =====================
                if [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "image_name_ok" ]]; then
                                QUIZ_IMAGE_NAME="ubuntu24.04-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_IMAGE_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: image name not match"
                                fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "flavor_name_ok" ]]; then
                                QUIZ_FLAVOR_NAME="flav-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_FLAVOR_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: flavor name not match"
                                fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "flavor_spec_ok" ]]; then
                                QUIZ_FLAVOR_NAME="flav-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack flavor show "$QUIZ_FLAVOR_NAME" -f json 2>/dev/null || echo "")
                                RAM=$(echo "$OUTPUT"   | jq -r '.ram // empty')
                                DISK=$(echo "$OUTPUT"  | jq -r '.disk // empty')
                                VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')
                                if [[ "$RAM" == "1024" && "$DISK" == "4" && "$VCPUS" == "2" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: flavor spec mismatch"
                                fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "keypair_name_ok" ]]; then
                                QUIZ_KEYPAIR_NAME="key-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_KEYPAIR_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: keypair name not match"
                                fi

                # ===================== QUIZ 001-2 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_image_deleted" ]]; then
                                QUIZ_IMAGE_NAME="ubuntu24.04-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_IMAGE_NAME"; then
                                                DATA["$KEY"]="Error: image masih ada"
                                else
                                                DATA["$KEY"]="OK"
                                fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_flavor_deleted" ]]; then
                                QUIZ_FLAVOR_NAME="flav-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_FLAVOR_NAME"; then
                                                DATA["$KEY"]="Error: flavor masih ada"
                                else
                                                DATA["$KEY"]="OK"
                                fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_keypair_deleted" ]]; then
                                QUIZ_KEYPAIR_NAME="key-quiz001-1-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$QUIZ_KEYPAIR_NAME"; then
                                                DATA["$KEY"]="Error: keypair masih ada"
                                else
                                                DATA["$KEY"]="OK"
                                fi

                # ===================== OSADM-002-2 =====================
                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_net_name_ok" ]]; then
                                NET_NAME="internal-net-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: internal network not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_subnet_cidr_ok" ]]; then
                                OUTPUT=$(openstack subnet show "internal-subnet-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')
                                EXPECTED_CIDR="192.20.${EXPECTED_INTERNAL_OCTET}.0/24"
                                if [[ "$CIDR" == "$EXPECTED_CIDR" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong internal subnet CIDR"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_subnet_pool_ok" ]]; then
                                OUTPUT=$(openstack subnet show "internal-subnet-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                GATEWAY=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                                POOL_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                                POOL_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')

                                EXPECTED_GW="192.20.${EXPECTED_INTERNAL_OCTET}.1"
                                EXPECTED_START="192.20.${EXPECTED_INTERNAL_OCTET}.10"
                                EXPECTED_END="192.20.${EXPECTED_INTERNAL_OCTET}.254"

                                if [[ "$GATEWAY" == "$EXPECTED_GW" && "$POOL_START" == "$EXPECTED_START" && "$POOL_END" == "$EXPECTED_END" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong internal gateway or allocation pool"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_net_binding_ok" ]]; then
                                OUTPUT=$(openstack subnet show "internal-subnet-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                NET_ID=$(echo "$OUTPUT" | jq -r '.network_id // empty')
                                INTERNAL_NET_ID=$(openstack network show "internal-net-${EXPECTED_SUFFIX}" -f json 2>/dev/null | jq -r '.id // empty')
                                if [[ -n "$NET_ID" && -n "$INTERNAL_NET_ID" && "$NET_ID" == "$INTERNAL_NET_ID" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: subnet not attached to internal-net"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_name_ok" ]]; then
                                ROUTER_NAME="router-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack router list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$ROUTER_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: router not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_ext_gw_ok" ]]; then
                                OUTPUT=$(openstack router show "router-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                EXT_NET_ID=$(echo "$OUTPUT" | jq -r '.external_gateway_info.network_id // empty')
                                EXT_IP=$(echo "$OUTPUT" | jq -r '.external_gateway_info.external_fixed_ips[0].ip_address // empty')
                                EXTERNAL_NET_ID=$(openstack network show external-net-sija -f json 2>/dev/null | jq -r '.id // empty')
                                if [[ "$EXT_NET_ID" == "$EXTERNAL_NET_ID" && "$EXT_IP" == "172.20.10.${RANGE_START_INT}" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong external gateway or IP"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_internal_iface_ok" ]]; then
                                OUTPUT=$(openstack router show "router-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                                INTERNAL_SUBNET_ID=$(openstack subnet show "internal-subnet-${EXPECTED_SUFFIX}" -f json 2>/dev/null | jq -r '.id // empty')
                                if echo "$SUBNETS" | grep -Fxq "$INTERNAL_SUBNET_ID"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: internal subnet not attached to router"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "floating_ip_ok" ]]; then
                                OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                                HAS_FIP=$(echo "$OUTPUT" | jq -r --arg start "$FIP_RANGE_START_INT" --arg end "$FIP_RANGE_END_INT" '
                                  .[]?
                                  | .["Floating IP Address"] // empty
                                  | select(
                                      split(".") | .[3] | tonumber >= ($start | tonumber) and tonumber <= ($end | tonumber)
                                    )
                                ' | head -n1)

                                if [[ -n "$HAS_FIP" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: no floating IP in expected range"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "secgroup_name_ok" ]]; then
                                SG_NAME="security-group-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: security group not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "secgroup_rules_ok" ]]; then
                                OUTPUT=$(openstack security group rule list "security-group-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "[]")
                                HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                                  .[]?
                                  | select(."IP Protocol" == "icmp" and .Direction == "ingress")
                                  | .ID
                                ' | head -n1)
                                HAS_SSH=$(echo "$OUTPUT" | jq -r '
                                  .[]?
                                  | select(."IP Protocol" == "tcp"
                                                   and ."Port Range" == "22:22"
                                                   and .Direction == "ingress")
                                  | .ID
                                ' | head -n1)
                                if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: missing ICMP or SSH rule"
                                fi


                # ===================== OSADM-002-3 (GUI-based) =====================
                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_net_name_ok" ]]; then
                                OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Eq "^intnet-horizon-${EXPECTED_SUFFIX}$"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: internal network not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_cidr_ok" ]]; then
                                OUTPUT=$(openstack subnet list -f json 2>/dev/null || echo "[]")
                                FOUND=$(echo "$OUTPUT" | jq -r "
                                  .[]?
                                  | select(.Name != null and (.Name | contains(\"horizon-${EXPECTED_SUFFIX}\")))
                                  | .Subnet
                                ")
                                EXPECTED_CIDR="192.168.${EXPECTED_INTERNAL_OCTET}.0/24"
                                if [[ "$FOUND" == "$EXPECTED_CIDR" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong internal subnet CIDR"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_pool_ok" ]]; then
                                OUTPUT=$(openstack subnet show "intsubnet-horizon-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                GATEWAY=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                                POOL_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                                POOL_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')

                                EXPECTED_GW="192.168.${EXPECTED_INTERNAL_OCTET}.1"
                                EXPECTED_START="192.168.${EXPECTED_INTERNAL_OCTET}.7"
                                EXPECTED_END="192.168.${EXPECTED_INTERNAL_OCTET}.250"

                                if [[ "$GATEWAY" == "$EXPECTED_GW" && "$POOL_START" == "$EXPECTED_START" && "$POOL_END" == "$EXPECTED_END" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong internal gateway or allocation pool"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_dns_ok" ]]; then
                                OUTPUT=$(openstack subnet show "intsubnet-horizon-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                DNS_LIST=$(echo "$OUTPUT" | jq -r '.dns_nameservers[]? // empty' | sort)
                                if echo "$DNS_LIST" | grep -q "8.8.4.4" && echo "$DNS_LIST" | grep -q "8.8.8.8"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: missing or wrong DNS nameservers"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_name_ok" ]]; then
                                ROUTER_NAME="ro-horizon-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack router list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$ROUTER_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: router not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_ext_gw_ok" ]]; then
                                OUTPUT=$(openstack router show "ro-horizon-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                EXT_NET_ID=$(echo "$OUTPUT" | jq -r '.external_gateway_info.network_id // empty')
                                EXT_IP=$(echo "$OUTPUT" | jq -r '.external_gateway_info.external_fixed_ips[0].ip_address // empty')
                                EXTERNAL_NET_ID=$(openstack network show external-net-sija -f json 2>/dev/null | jq -r '.id // empty')
                                if [[ "$EXT_NET_ID" == "$EXTERNAL_NET_ID" && "$EXT_IP" == "172.20.10.${RANGE_START_INT}" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: wrong external gateway or IP"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_internal_iface_ok" ]]; then
                                OUTPUT=$(openstack router show "ro-horizon-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "")
                                SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                                SUBNET_ID=$(openstack subnet list -f json 2>/dev/null | jq -r "
                                  .[]?
                                  | select(.Name != null and (.Name | contains(\"horizon-${EXPECTED_SUFFIX}\")))
                                  | .ID
                                ")
                                if echo "$SUBNETS" | grep -Fxq "$SUBNET_ID"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: internal subnet not attached to router"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "floating_ip_ok" ]]; then
                                OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                                HAS_FIP=$(echo "$OUTPUT" | jq -r --arg start "$FIP_RANGE_START_INT" --arg end "$FIP_RANGE_END_INT" '
                                  .[]?
                                  | .["Floating IP Address"] // empty
                                  | select(
                                      split(".") | .[1] | tonumber >= ($start | tonumber) and tonumber <= ($end | tonumber)
                                    )
                                ' | head -n1)

                                if [[ -n "$HAS_FIP" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: no floating IP in expected range"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "secgroup_name_ok" ]]; then
                                SG_NAME="sg-horizon-${EXPECTED_SUFFIX}"
                                OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: security group not found"
                                fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "secgroup_rules_ok" ]]; then
                                OUTPUT=$(openstack security group rule list "sg-horizon-${EXPECTED_SUFFIX}" -f json 2>/dev/null || echo "[]")
                                HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                                  .[]?
                                  | select(."IP Protocol" == "icmp" and .Direction == "ingress")
                                  | .ID
                                ' | head -n1)
                                HAS_SSH=$(echo "$OUTPUT" | jq -r '
                                  .[]?
                                  | select(."IP Protocol" == "tcp"
                                                   and ."Port Range" == "22:22"
                                                   and .Direction == "ingress")
                                  | .ID
                                ' | head -n1)
                                HAS_HTTP=$(echo "$OUTPUT" | jq -r '
                                  .[]?
                                  | select(."IP Protocol" == "tcp"
                                                   and ."Port Range" == "80:80"
                                                   and .Direction == "ingress")
                                  | .ID
                                ' | head -n1)
                                if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" && -n "$HAS_HTTP" ]]; then
                                                DATA["$KEY"]="OK"
                                else
                                                DATA["$KEY"]="Error: missing ICMP, SSH, or HTTP rule"
                                fi

                # ===================== OSADM-003-2 (Launch instance via CLI) =====================
                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_created_ok" ]]; then
                        SUFFIX_NO_DASH=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        NAME="cirros-cli-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$NAME"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: instance $NAME not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_params_ok" ]]; then
                        SUFFIX_NO_DASH=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        NAME="cirros-cli-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                        FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                        IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                        KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                        SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | sort | tr '\n' ' ')
                        NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                        EXP_FLAVOR="fl-lab001-2-$SUFFIX_NO_DASH"
                        EXP_IMAGE="cirros-lab001-2-$SUFFIX_NO_DASH"
                        EXP_KEY="key-lab001-2-$SUFFIX_NO_DASH"
                        EXP_SG="security-group-$EXPECTED_SUFFIX"
                        EXP_NET="internal-net-$EXPECTED_SUFFIX"

                        if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                                  "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                                  "$NETS" == *"$EXP_NET"* ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: server parameters mismatch (Check Flavor/Image/Key/SG/Net)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_fip_ok" ]]; then
                        SUFFIX_NO_DASH=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        NAME="cirros-cli-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                        # HITUNG IP PERTAMA DARI RANGE:
                        # FIP_RANGE_START_INT didapat dari fungsi determine_dynamic_variables
                        # Karena IP pertama, maka Offset = 0
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 0))
                        TARGET_FIP="172.20.10.${TARGET_OCTET}"

                        DETECTED_FIP=$(echo "$OUTPUT" | jq -r '
                          .addresses
                          | ..?
                          | strings
                          | select(test("^172\\.20\\.10\\."))
                        ' | head -n1)

                        if [[ "$DETECTED_FIP" == "$TARGET_FIP" ]]; then
                                DATA["$KEY"]="OK"
                        elif [[ -n "$DETECTED_FIP" ]]; then
                                DATA["$KEY"]="Error: IP attached is $DETECTED_FIP, but expected $TARGET_FIP (IP pertama)"
                        else
                                DATA["$KEY"]="Error: No floating IP attached to $NAME"
                        fi

                # ===================== OSADM-003-3 (Launch instance in Horizon) =====================
                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_created_ok" ]]; then
                        SUFFIX_NO_DASH=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        NAME="noble-horizon-ins-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$NAME"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: instance $NAME not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_params_ok" ]]; then
                        SUFFIX_NO_DASH=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        NAME="noble-horizon-ins-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                        FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                        IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                        KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                        SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | sort | tr '\n' ' ')
                        NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                        EXP_FLAVOR="fl-horizon-$SUFFIX_NO_DASH"
                        EXP_IMAGE="ubuntu24-horizon-$SUFFIX_NO_DASH"
                        EXP_KEY="key-horizon-$SUFFIX_NO_DASH"
                        EXP_SG="sg-horizon-$EXPECTED_SUFFIX"
                        EXP_NET="intnet-horizon-$SUFFIX_NO_DASH"

                        if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                                  "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                                  "$NETS" == *"$EXP_NET"* ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: server parameters mismatch (Check Flavor/Image/Key/SG/Net)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_userdata_ok" ]]; then
                        NAME="noble-horizon-ins-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                        USERDATA=$(echo "$OUTPUT" | jq -r '."OS-EXT-SRV-ATTR:user_data" // empty')

                        if [[ -z "$USERDATA" ]]; then
                                DATA["$KEY"]="Error: user_data not visible"
                        else
                                EXP_HOSTNAME="noble-horizon-$EXPECTED_SUFFIX"
                                DECODED_DATA=$(echo "$USERDATA" | base64 -d 2>/dev/null)

                                if echo "$DECODED_DATA" | grep -q "hostname: $EXP_HOSTNAME" && \
                                   echo "$DECODED_DATA" | grep -q "name: userlab33"; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: cloud-init config mismatch (check hostname: $EXP_HOSTNAME)"
                                fi
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_fip_ok" ]]; then
                        # HITUNG IP DINAMIS:
                        # Berdasarkan logika: Guru .60 dari base .59 (Offset +1)
                        # FIP_RANGE_START_INT didapat dari fungsi determine_dynamic_variables
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 1))
                        CURRENT_FIP="172.20.10.${TARGET_OCTET}"

                        FIP_CHECK=$(openstack floating ip show "$CURRENT_FIP" -f json 2>/dev/null | jq -r '.fixed_ip_address // empty')
                        if [[ -n "$FIP_CHECK" && "$FIP_CHECK" != "null" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: FIP $CURRENT_FIP not attached to instance"
                        fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_nginx_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 1))
                        CURRENT_FIP="172.20.10.${TARGET_OCTET}"

                        HTTP_OUT=$(curl -m 5 -s -I "http://$CURRENT_FIP/" 2>&1 || true)
                        if echo "$HTTP_OUT" | grep -q "200" && echo "$HTTP_OUT" | grep -qi "nginx"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: nginx not responding correctly on $CURRENT_FIP"
                        fi


                # ===================== OSADM-004-2 (Cinder Volume & Storage) =====================
                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "vol_created_attached_ok" ]]; then
                        VOL_NAME="volume-$EXPECTED_SUFFIX"
                        SERVER_NAME="cirros-cli-$EXPECTED_SUFFIX"

                        VOL_OUTPUT=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null || echo "")
                        SIZE=$(echo "$VOL_OUTPUT" | jq -r '.size // empty')
                        STATUS=$(echo "$VOL_OUTPUT" | jq -r '.status // empty')
                        ATTACHMENTS=$(echo "$VOL_OUTPUT" | jq -r '.attachments // empty')

                        SERVER_ID=$(openstack server show "$SERVER_NAME" -f json 2>/dev/null | jq -r '.id // empty')

                        HAS_ATTACH_ID=$(echo "$ATTACHMENTS" | jq -r '.[0].server_id // empty')
                        DEV_PATH=$(echo "$ATTACHMENTS" | jq -r '.[0].device // empty')

                        if [[ "$SIZE" == "3" && "$STATUS" == "in-use" && \
                                  "$HAS_ATTACH_ID" == "$SERVER_ID" && "$DEV_PATH" == "/dev/vdb" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: mismatch on $VOL_NAME (Size:3GB, Status:in-use, Target:$SERVER_NAME, Dev:/dev/vdb)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "fs_mounted_ok" ]]; then
                        VOL_NAME="volume-$EXPECTED_SUFFIX"
                        SERVER_NAME="cirros-cli-$EXPECTED_SUFFIX"

                        TARGET_OCTET=$((FIP_RANGE_START_INT + 0))
                        FIP_TARGET="172.20.10.${TARGET_OCTET}"

                        OUTPUT=$(ssh -n -o StrictHostKeyChecking=no -o ConnectTimeout=5 cirros@"$FIP_TARGET" sudo lsblk -f 2>/dev/null || echo "")

                        VDB_INFO=$(echo "$OUTPUT" | awk '$1=="vdb" {print $2, $NF}' | head -n1)
                        FSTYPE=$(echo "$VDB_INFO" | awk '{print $1}')
                        MOUNTPOINT=$(echo "$VDB_INFO" | awk '{print $2}')

                        if [[ "$FSTYPE" == "ext4" && "$MOUNTPOINT" == "/data" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: /dev/vdb on $FIP_TARGET not ext4 or not mounted on /data"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "data_and_checksum_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 0))
                        FIP_TARGET="172.20.10.${TARGET_OCTET}"

                        FILE_LIST=$(ssh -n -o StrictHostKeyChecking=no cirros@"$FIP_TARGET" "sudo ls -1 /data" 2>/dev/null || echo "")
                        CHECKSUM_CONTENT=$(ssh -n -o StrictHostKeyChecking=no cirros@"$FIP_TARGET" "sudo cat /data/checksum.txt" 2>/dev/null || echo "")

                        REQUIRED_FILES=("words.txt" "debian-index.gz" "readme" "checksum.txt")
                        MISSING=0
                        for f in "${REQUIRED_FILES[@]}"; do
                                if ! echo "$FILE_LIST" | grep -Fxq "$f"; then MISSING=1; fi
                        done

                        if [[ $MISSING -eq 1 ]]; then
                                DATA["$KEY"]="Error: Required files missing in /data on $FIP_TARGET"
                        else
                                HAS_WORDS=$(echo "$CHECKSUM_CONTENT" | grep -q "/data/words.txt" && echo "yes" || echo "no")
                                HAS_DEBIAN=$(echo "$CHECKSUM_CONTENT" | grep -q "/data/debian-index.gz" && echo "yes" || echo "no")
                                HAS_README=$(echo "$CHECKSUM_CONTENT" | grep -q "/data/readme" && echo "yes" || echo "no")

                                if [[ "$HAS_WORDS" == "yes" && "$HAS_DEBIAN" == "yes" && "$HAS_README" == "yes" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: checksum.txt is incomplete"
                                fi
                        fi

                # ===================== OSADM-004-3 (Cinder Volume via Horizon) =====================
                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "vol_horizon_created_attached_ok" ]]; then
                        VOL_NAME="vol-horizon-$EXPECTED_SUFFIX"
                        SERVER_NAME="noble-horizon-ins-$EXPECTED_SUFFIX"

                        VOL_OUTPUT=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null || echo "")
                        SIZE=$(echo "$VOL_OUTPUT" | jq -r '.size // empty')
                        STATUS=$(echo "$VOL_OUTPUT" | jq -r '.status // empty')
                        ATTACHMENTS=$(echo "$VOL_OUTPUT" | jq -r '.attachments // empty')

                        SERVER_ID=$(openstack server show "$SERVER_NAME" -f json 2>/dev/null | jq -r '.id // empty')

                        HAS_ATTACH_ID=$(echo "$ATTACHMENTS" | jq -r '.[0].server_id // empty')
                        DEV_PATH=$(echo "$ATTACHMENTS" | jq -r '.[0].device // empty')

                        if [[ "$SIZE" == "2" && "$STATUS" == "in-use" && \
                                  "$HAS_ATTACH_ID" == "$SERVER_ID" && "$DEV_PATH" == "/dev/vdb" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: mismatch on $VOL_NAME (Size:2GB, Status:in-use, Target:$SERVER_NAME, Dev:/dev/vdb)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "fs_horizon_mounted_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 1))
                        FIP_TARGET="172.20.10.${TARGET_OCTET}"

                        MOUNT_INFO=$(ssh -n -o StrictHostKeyChecking=no userlab33@"$FIP_TARGET" "grep '/dev/vdb' /etc/mtab" 2>/dev/null || echo "")

                        if echo "$MOUNT_INFO" | grep -q "/dev/vdb" && \
                           echo "$MOUNT_INFO" | grep -q "ext4" && \
                           echo "$MOUNT_INFO" | grep -q " /data "; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: /dev/vdb on $FIP_TARGET not ext4 or not mounted on /data"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "data_horizon_files_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 1))
                        FIP_TARGET="172.20.10.${TARGET_OCTET}"

                        FILE_LIST=$(ssh -n -o StrictHostKeyChecking=no userlab33@"$FIP_TARGET" "sudo ls -1 /data" 2>/dev/null || echo "")

                        if echo "$FILE_LIST" | grep -Fxq "words.txt" && \
                           echo "$FILE_LIST" | grep -Fxq "debian-index.gz" && \
                           echo "$FILE_LIST" | grep -Fxq "readme"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: required files missing in /data on $FIP_TARGET"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "checksum_horizon_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 1))
                        FIP_TARGET="172.20.10.${TARGET_OCTET}"

                        CHECKSUM_CONTENT=$(ssh -n -o StrictHostKeyChecking=no userlab33@"$FIP_TARGET" "sudo cat /data/checksum.txt" 2>/dev/null || echo "")

                        if [[ -n "$CHECKSUM_CONTENT" ]] && \
                           echo "$CHECKSUM_CONTENT" | grep -q "words.txt" && \
                           echo "$CHECKSUM_CONTENT" | grep -q "debian-index.gz" && \
                           echo "$CHECKSUM_CONTENT" | grep -q "readme"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: checksum.txt on $FIP_TARGET missing or incomplete"
                        fi

                # ===================== OSADM-004-4 (Rescue VM & Data Recovery) =====================
                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "volume_detached_available_ok" ]]; then
                        VOL_NAME="vol-horizon-$EXPECTED_SUFFIX"

                        STATUS=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null | jq -r '.status // empty')
                        if [[ "$STATUS" == "available" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: volume $VOL_NAME status is $STATUS (expected available)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_vm_created_ok" ]]; then
                        VM_RESCUE_NAME="vm-rescue-$EXPECTED_SUFFIX"

                        VM_STATUS=$(openstack server show "$VM_RESCUE_NAME" -f json 2>/dev/null | jq -r '.status // empty')
                        if [[ "$VM_STATUS" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: VM $VM_RESCUE_NAME status is $VM_STATUS (expected ACTIVE)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_volume_attached_ok" ]]; then
                        VOL_NAME="vol-horizon-$EXPECTED_SUFFIX"
                        VM_RESCUE_NAME="vm-rescue-$EXPECTED_SUFFIX"

                        VOL_OUTPUT=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null || echo "")
                        VM_ID=$(openstack server show "$VM_RESCUE_NAME" -f json 2>/dev/null | jq -r '.id // empty')

                        ATTACH_ID=$(echo "$VOL_OUTPUT" | jq -r '.attachments[0].server_id // empty')
                        DEV_PATH=$(echo "$VOL_OUTPUT" | jq -r '.attachments[0].device // empty')

                        if [[ "$ATTACH_ID" == "$VM_ID" && "$DEV_PATH" == *"/dev/vd"* ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: volume not attached to $VM_RESCUE_NAME (Device: $DEV_PATH)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_checksum_valid_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 3))
                        FIP_RESCUE="172.20.10.${TARGET_OCTET}"

                        CHECKSUM_RESULT=$(ssh -n -o StrictHostKeyChecking=no userlab44@"$FIP_RESCUE" "cd /data && sudo sha256sum -c checksum.txt 2>&1" 2>/dev/null || echo "")

                        if echo "$CHECKSUM_RESULT" | grep -q "OK" && ! echo "$CHECKSUM_RESULT" | grep -q "FAILED"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: checksum validation failed on $FIP_RESCUE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_backup_created_ok" ]]; then
                        TARGET_OCTET=$((FIP_RANGE_START_INT + 3))
                        FIP_RESCUE="172.20.10.${TARGET_OCTET}"

                        BACKUP_FILE="backup_data_$EXPECTED_SUFFIX.tar.gz"
                        BACKUP_INFO=$(ssh -n -o StrictHostKeyChecking=no userlab44@"$FIP_RESCUE" "ls -l ~/$BACKUP_FILE 2>&1" 2>/dev/null || echo "")

                        if echo "$BACKUP_INFO" | grep -q "$BACKUP_FILE" && echo "$BACKUP_INFO" | grep -q "userlab44"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: backup file $BACKUP_FILE not found or wrong owner on $FIP_RESCUE"
                        fi

                # ===================== OSADM-005-2 (HAProxy Load Balancer) =====================
                elif [[ "$LAB_ID" == "OSADM-005-2" && "$KEY" == "haproxy_vm_ok" ]]; then
                        HAPROXY_VM="haproxy-$EXPECTED_SUFFIX"
                        HAPROXY_STATUS=$(openstack server show "$HAPROXY_VM" -f json 2>/dev/null | jq -r '.status // empty')
                        if [[ "$HAPROXY_STATUS" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: $HAPROXY_VM not ACTIVE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-2" && "$KEY" == "backends_vm_ok" ]]; then
                        BACKEND1_VM="backend1-$EXPECTED_SUFFIX"
                        BACKEND2_VM="backend2-$EXPECTED_SUFFIX"

                        B1_STAT=$(openstack server show "$BACKEND1_VM" -f json 2>/dev/null | jq -r '.status // empty')
                        B2_STAT=$(openstack server show "$BACKEND2_VM" -f json 2>/dev/null | jq -r '.status // empty')

                        if [[ "$B1_STAT" == "ACTIVE" && "$B2_STAT" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Backends not ACTIVE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-2" && "$KEY" == "haproxy_config_ok" ]]; then
                        HAPROXY_VM="haproxy-$EXPECTED_SUFFIX"
                        SSH_USER=$(echo "$EXPECTED_SUFFIX" | tr -d '-')

                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        IP_B1="$(echo "$TARGET_LB_NET" | cut -d. -f1-3).12"
                        IP_B2="$(echo "$TARGET_LB_NET" | cut -d. -f1-3).13"

                        CONFIG=$(sshpass -p "haproxy" ssh -n -o StrictHostKeyChecking=no -o ConnectTimeout=5 "${SSH_USER}@${FIP_HAPROXY}" "cat /etc/haproxy/haproxy.cfg" 2>/dev/null || echo "")

                        if echo "$CONFIG" | grep -q "balance roundrobin" && \
                           echo "$CONFIG" | grep -q "${IP_B1}:80" && \
                           echo "$CONFIG" | grep -q "${IP_B2}:80"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Config mismatch (Check balance/IP Backends: $IP_B1, $IP_B2)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-2" && "$KEY" == "haproxy_fip_ok" ]]; then
                        HAPROXY_VM="haproxy-$EXPECTED_SUFFIX"
                        BACKEND1_VM="backend1-$EXPECTED_SUFFIX"
                        BACKEND2_VM="backend2-$EXPECTED_SUFFIX"

                        H_FIP=$(openstack server list --name "$HAPROXY_VM"  -f value -c Networks | grep "172.20.10." || true)
                        B1_FIP=$(openstack server list --name "$BACKEND1_VM" -f value -c Networks | grep "172.20.10." || true)
                        B2_FIP=$(openstack server list --name "$BACKEND2_VM" -f value -c Networks | grep "172.20.10." || true)

                        if [[ -n "$H_FIP" && -z "$B1_FIP" && -z "$B2_FIP" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: FIP still attached to backends"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-2" && "$KEY" == "haproxy_backend_response_ok" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        B1_C=0; B2_C=0
                        for i in {1..4}; do
                                RES=$(curl -s --max-time 2 "http://${FIP_HAPROXY}/")
                                [[ "$RES" =~ "Backend1" ]] && ((B1_C++))
                                [[ "$RES" =~ "Backend2" ]] && ((B2_C++))
                        done

                        if [[ $B1_C -ge 1 && $B2_C -ge 1 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: B1=$B1_C B2=$B2_C (Round Robin not detected in 4 tries)"
                        fi

                # ===================== OSADM-005-3 (HAProxy SSH Load Balancing) =====================
                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "haproxy_vm_ok" ]]; then
                        HAPROXY_VM="haproxy-$EXPECTED_SUFFIX"
                        HAPROXY_STATUS=$(openstack server show "$HAPROXY_VM" -f json 2>/dev/null | jq -r '.status // empty')
                        if [[ "$HAPROXY_STATUS" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: $HAPROXY_VM is not ACTIVE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "backends_vm_ok" ]]; then
                        BACKEND1_VM="backend1-$EXPECTED_SUFFIX"
                        BACKEND2_VM="backend2-$EXPECTED_SUFFIX"

                        B1_STAT=$(openstack server show "$BACKEND1_VM" -f json 2>/dev/null | jq -r '.status // empty')
                        B2_STAT=$(openstack server show "$BACKEND2_VM" -f json 2>/dev/null | jq -r '.status // empty')

                        if [[ "$B1_STAT" == "ACTIVE" && "$B2_STAT" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Backends not ACTIVE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "haproxy_ssh_config_ok" ]]; then
                        HAPROXY_VM="haproxy-$EXPECTED_SUFFIX"
                        SSH_USER=$(echo "$EXPECTED_SUFFIX" | tr -d '-')

                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        IP_B1="$(echo "$TARGET_LB_NET" | cut -d. -f1-3).12"
                        IP_B2="$(echo "$TARGET_LB_NET" | cut -d. -f1-3).13"

                        CONFIG=$(sshpass -p "haproxy" ssh -n -o StrictHostKeyChecking=no -o ConnectTimeout=5 "${SSH_USER}@${FIP_HAPROXY}" "cat /etc/haproxy/haproxy.cfg" 2>/dev/null || echo "")

                        if echo "$CONFIG" | grep -q "frontend ssh_front" && \
                           echo "$CONFIG" | grep -q "bind \*:2222" && \
                           echo "$CONFIG" | grep -q "backend ssh_back" && \
                           echo "$CONFIG" | grep -q "balance roundrobin" && \
                           echo "$CONFIG" | grep -q "${IP_B1}:22" && \
                           echo "$CONFIG" | grep -q "${IP_B2}:22"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Config mismatch. Check port 2222, balance roundrobin, and backend IPs ($IP_B1, $IP_B2)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "haproxy_ssh_port_ok" ]]; then
                        SSH_USER=$(echo "$EXPECTED_SUFFIX" | tr -d '-')
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        PORTS=$(sshpass -p "haproxy" ssh -n -o StrictHostKeyChecking=no -o ConnectTimeout=5 "${SSH_USER}@${FIP_HAPROXY}" "sudo ss -tlnp" 2>/dev/null || echo "")

                        if echo "$PORTS" | grep -q ":22 " && echo "$PORTS" | grep -q ":2222 "; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Port 22 (SSH) or 2222 (HAProxy) not listening on $FIP_HAPROXY"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "backend_ssh_service_ok" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        if timeout 3 bash -c "cat < /dev/null > /dev/tcp/${FIP_HAPROXY}/2222" 2>/dev/null; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Cannot connect to SSH service via HAProxy port 2222"
                        fi

                elif [[ "$LAB_ID" == "OSADM-005-3" && "$KEY" == "haproxy_ssh_roundrobin_ok" ]]; then
                        DATA["$KEY"]="exists"

                # ===================== OSADM-006-2 (Auto Scaling Heat Stack) =====================
                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "stack_name_ok" ]]; then
                        STACK_NAME="instance-stack-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack stack show "$STACK_NAME" -f value -c stack_status 2>&1)
                        if echo "$OUTPUT" | grep -qi "UPDATE_COMPLETE\|CREATE_COMPLETE"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Stack $STACK_NAME not ready or not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "stack_events_scale_ok" ]]; then
                        STACK_NAME="instance-stack-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack stack event list "$STACK_NAME" 2>/dev/null)

                        SCALE_OUT_COUNT=$(echo "$OUTPUT" | grep "\.scale_out_policy\]" | grep "SIGNAL_COMPLETE" | wc -l)
                        SCALE_IN_COUNT=$(echo "$OUTPUT" | grep "\.scale_in_policy\]" | grep "SIGNAL_COMPLETE" | wc -l)

                        if [[ $SCALE_OUT_COUNT -ge 2 && $SCALE_IN_COUNT -ge 2 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Incomplete scaling history (Out:$SCALE_OUT_COUNT, In:$SCALE_IN_COUNT). Need >=2 each."
                        fi

                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "autoscaling_config_ok" ]]; then
                        STACK_NAME="instance-stack-$EXPECTED_SUFFIX"

                        TEMPLATE=$(openstack stack template show "$STACK_NAME" 2>/dev/null)

                        MIN_SIZE=$(echo "$TEMPLATE" | grep "min_size:" | awk '{print $2}' | tr -d ',:')
                        MAX_SIZE=$(echo "$TEMPLATE" | grep "max_size:" | awk '{print $2}' | tr -d ',:')
                        DESIRED=$(echo "$TEMPLATE" | grep "desired_capacity:" | awk '{print $2}' | tr -d ',:')

                        THRESHOLDS=$(echo "$TEMPLATE" | grep "threshold:" | awk '{print $2}' | tr -d ',:')
                        CPU_HIGH=$(echo "$THRESHOLDS" | head -1)
                        CPU_LOW=$(echo "$THRESHOLDS" | tail -1)

                        if [[ "$MIN_SIZE" == "1" ]] && [[ $MAX_SIZE -ge 2 ]] && \
                           [[ "$DESIRED" == "1" ]] && [[ -n "$CPU_HIGH" ]] && [[ -n "$CPU_LOW" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Config mismatch (Min:$MIN_SIZE, Max:$MAX_SIZE, Desired:$DESIRED). Check CPU thresholds."
                        fi

                # ===================== OSADM-007-2 (HAProxy Failover Test) =====================
                elif [[ "$LAB_ID" == "OSADM-007-2" && "$KEY" == "http_backend2_failover_ok" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"

                        B1_NAME="backend1-$EXPECTED_SUFFIX"
                        B2_NAME="backend2-$EXPECTED_SUFFIX"

                        OK_COUNT=0
                        for i in {1..4}; do
                                OUT=$(curl -s --max-time 5 "http://$FIP_HAPROXY" 2>&1)
                                if echo "$OUT" | grep -qi "$B1_NAME"; then
                                        ((OK_COUNT++))
                                fi
                        done

                        if [[ $OK_COUNT -eq 4 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Only $OK_COUNT/4 response from $B1_NAME. Is $B2_NAME still alive or $B1_NAME down?"
                        fi

                elif [[ "$LAB_ID" == "OSADM-007-2" && "$KEY" == "ssh_backend1_failover_ok" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 4))
                        FIP_HAPROXY="172.20.10.${TARGET_OCTET_FIP}"
                        SSH_USER=$(echo "$EXPECTED_SUFFIX" | tr -d '-')

                        B2_NAME="backend2-$EXPECTED_SUFFIX"

                        OUT=$(sshpass -p "haproxy" ssh -n -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                              -o ConnectTimeout=5 -p 2222 "${SSH_USER}@${FIP_HAPROXY}" "hostname" 2>&1)

                        if echo "$OUT" | grep -qi "$B2_NAME"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: SSH failover failed. Expected $B2_NAME, but got: $OUT"
                        fi

                # ===================== OSADM-008-2 (Git Fundamentals) =====================
                elif [[ "$LAB_ID" == "OSADM-008-2" && "$KEY" == "osadm-008-2-git-config" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"

                        GIT_USER_CONFIG=$(echo "$EXPECTED_SUFFIX" | tr -d '-')

                        OUT_CONFIG=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "git config --global --list" 2>/dev/null || echo "FAIL")

                        if echo "$OUT_CONFIG" | grep -qi "user.name=$GIT_USER_CONFIG" && \
                           echo "$OUT_CONFIG" | grep -qi "init.defaultbranch=main"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Git global config mismatch. Expected name=$GIT_USER_CONFIG and branch=main"
                        fi

                elif [[ "$LAB_ID" == "OSADM-008-2" && "$KEY" == "osadm-008-2-readme-check" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"

                        GIT_CONTENT_NAME="$EXPECTED_SUFFIX"

                        OUT_README=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "cat ~/verify-dir/README.md" 2>/dev/null || echo "FAIL")

                        EXPECT_CONTENT="Hai-$GIT_CONTENT_NAME"
                        if echo "$OUT_README" | grep -qi "$EXPECT_CONTENT"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: README.md mismatch. Expected content: $EXPECT_CONTENT"
                        fi

                # ===================== OSADM-008-3 (Git Staging) =====================
                elif [[ "$LAB_ID" == "OSADM-008-3" && "$KEY" == "osadm-008-3-commit-log" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"
                        REPO_DIR="our-project-$EXPECTED_SUFFIX"

                        OUT_LOG=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "cd ~/$REPO_DIR && git log --oneline" 2>/dev/null || echo "FAIL")

                        COMMIT_COUNT=$(echo "$OUT_LOG" | wc -l)
                        if [[ $COMMIT_COUNT -ge 2 ]] && echo "$OUT_LOG" | grep -qi "multiple files"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Commit 'multiple files' not found in $REPO_DIR or commits < 2"
                        fi

                elif [[ "$LAB_ID" == "OSADM-008-3" && "$KEY" == "osadm-008-3-files-check" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"

                        CHECK_FILES=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "ls ~/verify-dir-0083/file1.txt ~/verify-dir-0083/file2.txt ~/verify-dir-0083/file3.txt >/dev/null 2>&1 && echo OK || echo FAIL")

                        if [[ "$CHECK_FILES" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: file1.txt, file2.txt, or file3.txt missing in ~/verify-dir-0083"
                        fi

                # ===================== OSADM-008-4 (Git Branch & Merge) =====================
                elif [[ "$LAB_ID" == "OSADM-008-4" && "$KEY" == "osadm-008-4-merge-log" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"
                        REPO_DIR="our-project-$EXPECTED_SUFFIX"

                        OUT_LOG=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "cd ~/$REPO_DIR && git log --oneline" 2>/dev/null || echo "FAIL")

                        if echo "$OUT_LOG" | grep -qi "Resolve merge conflict"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Log 'Resolve merge conflict' not found in repo $REPO_DIR"
                        fi

                elif [[ "$LAB_ID" == "OSADM-008-4" && "$KEY" == "osadm-008-4-content-check" ]]; then
                        TARGET_OCTET_FIP=$((FIP_RANGE_START_INT + 6))
                        FIP_GIT="172.20.10.${TARGET_OCTET_FIP}"

                        OUT_README=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$FIP_GIT" "cat ~/verify-dir-0084/README.md" 2>/dev/null || echo "FAIL")

                        HAS_MAIN=$(echo "$OUT_README" | grep -qi "Update langsung dari main" && echo OK || echo NO)
                        HAS_FEAT=$(echo "$OUT_README" | grep -qi "Update dari feature" && echo OK || echo NO)

                        if [[ "$HAS_MAIN" == "OK" ]] && [[ "$HAS_FEAT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: README.md incomplete. Must contain lines from both 'main' and 'feature' branches."
                        fi

                # ===================== QUIZ 002-1 (Orchestration & Security) =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "intnet_name_ok" ]]; then
                        NET_NAME="intnet-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: network $NET_NAME not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "intsubnet_cidr_ok" ]]; then
                        OUTPUT=$(openstack subnet show "intsubnet-quiz002-1-$EXPECTED_SUFFIX" -f json 2>/dev/null || echo "")
                        CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')

                        # Menggunakan EXPECTED_INTERNAL_OCTET dari helper
                        EXPECTED_CIDR="192.30.${EXPECTED_INTERNAL_OCTET}.0/24"

                        if [[ "$CIDR" == "$EXPECTED_CIDR" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: wrong CIDR (expected $EXPECTED_CIDR, got $CIDR)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "router_iface_ok" ]]; then
                        SUBNET_NAME="intsubnet-quiz002-1-$EXPECTED_SUFFIX"
                        ROUTER_NAME="ro-horizon-$EXPECTED_SUFFIX"

                        SUBNETS=$(openstack router show "$ROUTER_NAME" -f json 2>/dev/null | jq -r '.interfaces_info[].subnet_id // empty')
                        SUBNET_ID=$(openstack subnet show "$SUBNET_NAME" -f json 2>/dev/null | jq -r '.id // empty')
                        if [[ -n "$SUBNET_ID" ]] && echo "$SUBNETS" | grep -Fxq "$SUBNET_ID"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: $ROUTER_NAME not connected to $SUBNET_NAME"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "floating_ip_ok" ]]; then
                        OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                        HAS_FIP=$(echo "$OUTPUT" | jq -r --arg ip "$FLOATINGIP" '.[] | select(."Floating IP Address" == $ip) | ."Floating IP Address"' | head -n1)
                        if [[ "$HAS_FIP" == "$FLOATINGIP" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: floating IP $FLOATINGIP not found in project"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "secgroup_name_ok" ]]; then
                        SG_NAME="scg-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: security group $SG_NAME not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "secgroup_rules_ok" ]]; then
                        SG_NAME="scg-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack security group rule list "$SG_NAME" -f json 2>/dev/null || echo "[]")

                        HAS_ICMP=$(echo "$OUTPUT" | jq -r '.[]? | select(."IP Protocol" == "icmp" and .Direction == "ingress") | .ID' | head -n1)
                        HAS_SSH=$(echo "$OUTPUT"  | jq -r '.[]? | select(."IP Protocol" == "tcp" and ."Port Range" == "22:22"  and .Direction == "ingress") | .ID' | head -n1)
                        HAS_HTTP=$(echo "$OUTPUT" | jq -r '.[]? | select(."IP Protocol" == "tcp" and ."Port Range" == "80:80"  and .Direction == "ingress") | .ID' | head -n1)
                        HAS_HTTPS=$(echo "$OUTPUT"| jq -r '.[]? | select(."IP Protocol" == "tcp" and ."Port Range" == "443:443" and .Direction == "ingress") | .ID' | head -n1)

                        if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" && -n "$HAS_HTTP" && -n "$HAS_HTTPS" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: missing required rules in $SG_NAME"
                        fi

                # ===================== QUIZ 002-2 (Cleanup & Deletion) =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "intnet_deleted" ]]; then
                        NET_NAME="intnet-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                                DATA["$KEY"]="Error: internal network $NET_NAME masih ada"
                        else
                                DATA["$KEY"]="OK"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "intsubnet_deleted" ]]; then
                        SUBNET_NAME="intsubnet-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack subnet list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$SUBNET_NAME"; then
                                DATA["$KEY"]="Error: internal subnet $SUBNET_NAME masih ada"
                        else
                                DATA["$KEY"]="OK"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "router_iface_unset" ]]; then
                        SUBNET_NAME="intsubnet-quiz002-1-$EXPECTED_SUFFIX"
                        ROUTER_NAME="ro-horizon-$EXPECTED_SUFFIX"

                        QUIZ_SUBNET_ID=$(openstack subnet show "$SUBNET_NAME" -f json 2>/dev/null | jq -r '.id // empty')

                        if [[ -z "$QUIZ_SUBNET_ID" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                SUBNETS_IN_ROUTER=$(openstack router show "$ROUTER_NAME" -f json 2>/dev/null | jq -r '.interfaces_info[].subnet_id // empty')
                                if echo "$SUBNETS_IN_ROUTER" | grep -Fxq "$QUIZ_SUBNET_ID"; then
                                        DATA["$KEY"]="Error: router $ROUTER_NAME masih connected ke quiz subnet"
                                else
                                        DATA["$KEY"]="OK"
                                fi
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "floating_ip_deleted" ]]; then
                        OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                        HAS_FIP=$(echo "$OUTPUT" | jq -r --arg ip "$FLOATINGIP" '.[] | select(."Floating IP Address" == $ip) | ."Floating IP Address"' | head -n1)

                        if [[ -z "$HAS_FIP" || "$HAS_FIP" != "$FLOATINGIP" ]]; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: floating IP $FLOATINGIP masih ada (belum di-release)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "secgroup_deleted" ]]; then
                        SG_NAME="scg-quiz002-1-$EXPECTED_SUFFIX"

                        OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                                DATA["$KEY"]="Error: security group $SG_NAME masih ada"
                        else
                                DATA["$KEY"]="OK"
                        fi

                # ===================== OSADM-QUIZ-003-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" ]]; then

                        # 1. SETUP IDENTITAS (Sesuai Helper)
                        # Contoh: kelompok1-sija1
                        SUFFIX="$EXPECTED_SUFFIX"
                        # Format tanpa strip untuk folder & username: kelompok1sija1
                        RAW_ID="kelompok${GROUP_NUM}sija${CLASS_TYPE}"

                        # 2. DEFINISI RESOURCE DINAMIS
                        VM_NAME="2048-quiz003-1-$SUFFIX"
                        EXP_FLAVOR="quiz003-1-medium-$SUFFIX"
                        EXP_IMAGE="ubuntu24.04-quiz003-1-$SUFFIX"
                        EXP_NET="net-quiz003-1-$SUFFIX"
                        EXP_SUBNET="subnet-quiz003-1-$SUFFIX"
                        EXP_PORT="port-quiz003-1-$SUFFIX"
                        EXP_SG="sg-quiz003-1-$SUFFIX"
                        EXP_KEY="key-quiz003-1-$SUFFIX"

                        # 3. PERHITUNGAN IP (IP Ketiga dari Range)
                        # Jika START=69, maka IP ke-1=.69, ke-2=.70, ke-3=.71
                        FIP_THIRD=$((FIP_RANGE_START_INT + 2))
                        TARGET_FIP="172.20.10.${FIP_THIRD}"

                        if [[ "$KEY" == "quiz3_server_ok" ]]; then
                                OUTPUT=$(openstack server show "$VM_NAME" -f json 2>/dev/null || echo "")
                                FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                                IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                                KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                                SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | tr '\n' ' ')
                                NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                                if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                                          "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                                          "$NETS" == *"$EXP_NET"* ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: Spec mismatch (Flavor/Image/Key/SG/Net)"
                                fi

                        elif [[ "$KEY" == "quiz3_net_ok" ]]; then
                                OUTPUT=$(openstack subnet show "$EXP_SUBNET" -f json 2>/dev/null || echo "")
                                CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')
                                GW=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                                P_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                                P_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')
                                DNS=$(echo "$OUTPUT" | jq -r '.dns_nameservers[0] // empty')

                                EXPECTED_CIDR="172.19.${EXPECTED_INTERNAL_OCTET}.0/24"
                                EXPECTED_GW="172.19.${EXPECTED_INTERNAL_OCTET}.1"
                                EXPECTED_S="172.19.${EXPECTED_INTERNAL_OCTET}.35"
                                EXPECTED_E="172.19.${EXPECTED_INTERNAL_OCTET}.75"

                                if [[ "$CIDR" == "$EXPECTED_CIDR" && "$GW" == "$EXPECTED_GW" && \
                                          "$P_START" == "$EXPECTED_S" && "$P_END" == "$EXPECTED_E" && \
                                          "$DNS" == "8.8.8.8" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: Subnet/Pool mismatch (Exp: 172.19.${EXPECTED_INTERNAL_OCTET}.0/24)"
                                fi

                        elif [[ "$KEY" == "quiz3_port_ok" ]]; then
                                OUTPUT=$(openstack port show "$EXP_PORT" -f json 2>/dev/null || echo "")
                                FIX_IP=$(echo "$OUTPUT" | jq -r '.fixed_ips[0].ip_address // empty')
                                TARGET_FIXED="172.19.${EXPECTED_INTERNAL_OCTET}.47"

                                if [[ "$FIX_IP" == "$TARGET_FIXED" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: Port IP is $FIX_IP (Exp: $TARGET_FIXED)"
                                fi

                        elif [[ "$KEY" == "quiz3_fip_ok" ]]; then
                                OUTPUT=$(openstack server show "$VM_NAME" -f json 2>/dev/null || echo "")
                                ACTUAL_FIP=$(echo "$OUTPUT" | jq -r '.addresses | .[].[] | select(test("^172\\.20\\.10\\."))' | head -n1)

                                if [[ "$ACTUAL_FIP" == "$TARGET_FIP" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: Floating IP mismatch (Exp: $TARGET_FIP, Got: $ACTUAL_FIP)"
                                fi

                        elif [[ "$KEY" == "quiz3_nginx_2048_ok" ]]; then
                                HTTP_CHECK=$(curl -m 5 -s "http://$TARGET_FIP/" | grep -qi "2048" && echo "OK" || echo "FAIL")

                                SSH_USER="$RAW_ID"
                                FOLDER_CHECK=$(ssh -n -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_FIP" "[ -d /var/www/$RAW_ID ] && echo 'OK'" 2>/dev/null || echo "FAIL")

                                if [[ "$HTTP_CHECK" == "OK" && "$FOLDER_CHECK" == "OK" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: App not reachable or folder /var/www/$RAW_ID missing"
                                fi
                        fi

                # ===================== OSADM-QUIZ-004-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "vol_2048_created_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        VOL_ORIGINAL="vol-2048-$SUFFIX"

                        SIZE=$(openstack volume show "$VOL_ORIGINAL" -f value -c size 2>/dev/null)
                        if [[ "$SIZE" == "2" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Volume $VOL_ORIGINAL mismatch"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "vm_snapshot_created_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        SNAP_VM="snap-vm2048-$SUFFIX"

                        STATUS=$(openstack image show "$SNAP_VM" -f value -c status 2>/dev/null)
                        if [[ "$STATUS" == "active" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: VM Snapshot $SNAP_VM not active"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "vol_snapshot_created_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        SNAP_VOL="snap-vol2048-$SUFFIX"

                        STATUS=$(openstack volume snapshot show "$SNAP_VOL" -f value -c status 2>/dev/null)
                        if [[ "$STATUS" == "available" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Volume Snapshot $SNAP_VOL not available"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "vm_rescue_created_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        SNAP_VM="snap-vm2048-$SUFFIX"
                        VM_RESCUE="vm2048rescue-$SUFFIX"

                        OUTPUT=$(openstack server show "$VM_RESCUE" -f json 2>/dev/null || echo "")
                        IMG_ID=$(echo "$OUTPUT" | jq -r '.image // empty')
                        STATUS=$(echo "$OUTPUT" | jq -r '.status // empty')
                        SNAP_ID=$(openstack image show "$SNAP_VM" -f value -c id 2>/dev/null)

                        if [[ "$STATUS" == "ACTIVE" && "$IMG_ID" == "$SNAP_ID" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: VM Rescue not using $SNAP_VM or not active"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "vol_snapshot_attached_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        VM_RESCUE="vm2048rescue-$SUFFIX"
                        VOL_FROM_SNAP="vol-snap2048-$SUFFIX"

                        OUTPUT=$(openstack volume show "$VOL_FROM_SNAP" -f json 2>/dev/null || echo "")
                        STATUS=$(echo "$OUTPUT" | jq -r '.status // empty')
                        ATTACHED_TO=$(echo "$OUTPUT" | jq -r '.attachments[0].server_id // empty')
                        RESCUE_ID=$(openstack server show "$VM_RESCUE" -f value -c id 2>/dev/null)

                        if [[ "$STATUS" == "in-use" && "$ATTACHED_TO" == "$RESCUE_ID" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Volume $VOL_FROM_SNAP not attached to $VM_RESCUE"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-004-1" && "$KEY" == "backup_mounted_and_app_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        RAW_ID="kelompok${GROUP_NUM}sija${CLASS_TYPE}"

                        FIP_THIRD=$((FIP_RANGE_START_INT + 2))
                        TARGET_FIP="172.20.10.${FIP_THIRD}"

                        SSH_USER="$RAW_ID"

                        MOUNT_CHECK=$(ssh -n -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_FIP" "mount | grep /backup/$RAW_ID" 2>/dev/null || echo "")
                        NGINX_ROOT_CHECK=$(ssh -n -o StrictHostKeyChecking=no "$SSH_USER@$TARGET_FIP" "grep -r 'root /backup/$RAW_ID' /etc/nginx/" 2>/dev/null || echo "")
                        HTTP_CHECK=$(curl -m 5 -s "http://$TARGET_FIP/" | grep -qi "2048" && echo "OK" || echo "FAIL")

                        if [[ -n "$MOUNT_CHECK" && -n "$NGINX_ROOT_CHECK" && "$HTTP_CHECK" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Mount failed, Nginx root not updated, or app inaccessible"
                        fi

                # ===================== OSADM-QUIZ-005-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "haproxy_vm_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        STATUS=$(openstack server show "haproxy-$SUFFIX" -f value -c status 2>/dev/null)
                        if [[ "$STATUS" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: HAProxy VM not active"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "backends_vm_ok" ]]; then
                        LB_NET_PREFIX=$(echo "$TARGET_LB_NET" | cut -d. -f1-3)

                        B1_STATUS=$(openstack server list --ip "${LB_NET_PREFIX}.11" -f value -c Status 2>/dev/null)
                        B2_STATUS=$(openstack server list --ip "${LB_NET_PREFIX}.12" -f value -c Status 2>/dev/null)

                        if [[ "$B1_STATUS" == "ACTIVE" && "$B2_STATUS" == "ACTIVE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Backend IPs (${LB_NET_PREFIX}.11/12) not active"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "haproxy_http_weighted_ok" ]]; then
                        SSH_LB_PORT="2222"
                        HAPROXY_FIP="172.20.10.${FIP_RANGE_START_INT}"
                        LB_NET_PREFIX=$(echo "$TARGET_LB_NET" | cut -d. -f1-3)

                        CONFIG=$(ssh -n -o StrictHostKeyChecking=no ubuntu@"$HAPROXY_FIP" "cat /etc/haproxy/haproxy.cfg" 2>/dev/null)

                        B1_W=$(echo "$CONFIG" | grep "${LB_NET_PREFIX}.11" | grep -o "weight [0-9]*" | awk '{print $2}')
                        B2_W=$(echo "$CONFIG" | grep "${LB_NET_PREFIX}.12" | grep -o "weight [0-9]*" | awk '{print $2}')

                        if [[ "$B1_W" == "2" && "$B2_W" == "1" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Weight mismatch (B1=$B1_W, B2=$B2_W). Expected 2:1"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "haproxy_ssh_timeout_ok" ]]; then
                        SSH_LB_PORT="2222"
                        HAPROXY_FIP="172.20.10.${FIP_RANGE_START_INT}"

                        CONFIG=$(ssh -n -o StrictHostKeyChecking=no ubuntu@"$HAPROXY_FIP" "cat /etc/haproxy/haproxy.cfg" 2>/dev/null)

                        SSH_TIMEOUT=$(echo "$CONFIG" | sed -n "/$SSH_LB_PORT/,/backend\|frontend\|listen/p" | grep "timeout" | grep -E "2700s|45m" | head -n1)

                        if [[ -n "$SSH_TIMEOUT" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: SSH timeout 45m/2700s not found for port $SSH_LB_PORT"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "haproxy_healthcheck_ok" ]]; then
                        HAPROXY_FIP="172.20.10.${FIP_RANGE_START_INT}"

                        CONFIG=$(ssh -n -o StrictHostKeyChecking=no ubuntu@"$HAPROXY_FIP" "cat /etc/haproxy/haproxy.cfg" 2>/dev/null)

                        if echo "$CONFIG" | grep -q "check" && echo "$CONFIG" | grep -qE "option httpchk|option tcp-check"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Healthcheck configuration missing"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-005-1" && "$KEY" == "haproxy_http_weighted_verify_ok" ]]; then
                        HAPROXY_FIP="172.20.10.${FIP_RANGE_START_INT}"

                        B1_HITS=0
                        B2_HITS=0

                        for i in {1..6}; do
                                RES=$(curl -s --max-time 2 "http://$HAPROXY_FIP/")
                                if echo "$RES" | grep -qi "Backend1"; then
                                        ((B1_HITS++))
                                elif echo "$RES" | grep -qi "Backend2"; then
                                        ((B2_HITS++))
                                fi
                        done

                        if [[ $B1_HITS -gt $B2_HITS && $B2_HITS -gt 0 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: WRR Verification failed (B1 hits: $B1_HITS, B2 hits: $B2_HITS)"
                        fi

                # ===================== OSADM-QUIZ-006-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "stack_name_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        STACK_NAME="instance-stack-${SUFFIX}"

                        STACK_STATUS=$(openstack stack show "$STACK_NAME" -f value -c stack_status 2>/dev/null)
                        if [[ "$STACK_STATUS" == *"COMPLETE" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Stack $STACK_NAME not ready (Status: $STACK_STATUS)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "autoscaling_quiz_config_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        STACK_NAME="instance-stack-${SUFFIX}"

                        TEMPLATE=$(openstack stack template show "$STACK_NAME" 2>/dev/null)

                        MIN_SIZE=$(echo "$TEMPLATE" | grep "min_size:" | awk '{print $2}' | tr -d ',')
                        MINSZ="${MIN_SIZE//[!0-9]/}"

                        MAX_SIZE=$(echo "$TEMPLATE" | grep "max_size:" | awk '{print $2}' | tr -d ',')
                        MAXSZ="${MAX_SIZE//[!0-9]/}"

                        THRESHOLDS=$(echo "$TEMPLATE" | grep "threshold:" | awk '{print $2}' | tr -d ',')
                        CPU_HIGH=$(echo "$THRESHOLDS" | sort -nr | head -1)
                        CPU_LOW=$(echo "$THRESHOLDS" | sort -n | head -1)

                        if [[ "$MAXSZ" == "2" && "$MINSZ" == "1" && \
                                  "$CPU_HIGH" == "150000000000" && "$CPU_LOW" == "45000000000" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Config Mismatch (Max:$MAXSZ, High:$CPU_HIGH, Low:$CPU_LOW)"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "stack_events_scale_ok_quiz" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        STACK_NAME="instance-stack-${SUFFIX}"

                        OUTPUT=$(openstack stack event list "$STACK_NAME" 2>/dev/null)

                        S_OUT=$(echo "$OUTPUT" | grep -i "scale_out_policy" | grep "SIGNAL_COMPLETE" | wc -l)
                        S_IN=$(echo "$OUTPUT" | grep -i "scale_in_policy" | grep "SIGNAL_COMPLETE" | wc -l)

                        if [[ $S_OUT -ge 1 && $S_IN -ge 1 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Need real scaling activity (Scale-Out: $S_OUT, Scale-In: $S_IN)"
                        fi

                # ===================== OSADM-QUIZ-007-1 =====================
                elif [[ "$LAB_ID" == "QUIZ-007-1" && "$KEY" == "http_backend1_failover_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        RAW_ID="kelompok${GROUP_NUM}sija${CLASS_TYPE}"

                        # Guru: 59 + 4 = 63. Siswa lain menyesuaikan range masing-masing.
                        FIP_FIFTH=$((FIP_RANGE_START_INT + 4))
                        TARGET_FIP="172.20.10.${FIP_FIFTH}"

                        OK_COUNT=0
                        for i in {1..4}; do
                                OUT=$(curl -s --max-time 5 "http://$TARGET_FIP" 2>&1)
                                if echo "$OUT" | grep -qi "backend1-$SUFFIX"; then
                                        ((OK_COUNT++))
                                fi
                        done

                        if [[ $OK_COUNT -eq 4 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Only $OK_COUNT/4 response from Backend1 at $TARGET_FIP"
                        fi

                elif [[ "$LAB_ID" == "QUIZ-007-1" && "$KEY" == "ssh_backend2_failover_ok" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        RAW_ID="kelompok${GROUP_NUM}sija${CLASS_TYPE}"

                        FIP_FIFTH=$((FIP_RANGE_START_INT + 4))
                        TARGET_FIP="172.20.10.${FIP_FIFTH}"

                        OUT=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                                -o ConnectTimeout=5 -p 2222 "$RAW_ID@$TARGET_FIP" "hostname" 2>&1)

                        if echo "$OUT" | grep -qi "backend2-$SUFFIX"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: SSH failover failed. Target $TARGET_FIP:2222 returned: $OUT"
                        fi

                # ===================== OSADM-QUIZ-008-1 ENHANCED GRADING =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-008-1" && "$KEY" == "quiz-008-1-branch-check" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"
                        RAW_ID="kelompok${GROUP_NUM}sija${CLASS_TYPE}"

                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST="ubuntu@172.20.10.${FIP_SEVENTH}"
                        REPO_DIR="~/our-project-${SUFFIX}"

                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" "cd $REPO_DIR && git branch -a" 2>/dev/null || echo "FAIL")
                        if echo "$OUT" | grep -qi "feature-b"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Branch feature-b not found in $REPO_DIR"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-008-1" && "$KEY" == "quiz-008-1-feature-commit" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST="ubuntu@172.20.10.${FIP_SEVENTH}"
                        REPO_DIR="~/our-project-${SUFFIX}"

                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" "cd $REPO_DIR && git log --all --oneline" 2>/dev/null || echo "FAIL")
                        if echo "$OUT" | grep -qi "feature branch"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Feature commit message not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-008-1" && "$KEY" == "quiz-008-1-merge-log" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST="ubuntu@172.20.10.${FIP_SEVENTH}"
                        REPO_DIR="~/our-project-${SUFFIX}"

                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" "cd $REPO_DIR && git log --oneline" 2>/dev/null || echo "FAIL")
                        if echo "$OUT" | grep -qi "Resolve merge conflict"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Merge conflict resolution commit not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-008-1" && "$KEY" == "quiz-008-1-verify-dir" ]]; then
                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST="ubuntu@172.20.10.${FIP_SEVENTH}"
                        VERIFY_DIR="~/verify-dir-0084"

                        ssh -n -o StrictHostKeyChecking=no "$HOST" "ls -d $VERIFY_DIR" >/dev/null 2>&1
                        if [[ $? -eq 0 ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Directory $VERIFY_DIR not found"
                        fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-008-1" && "$KEY" == "quiz-008-1-content-check" ]]; then
                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST="ubuntu@172.20.10.${FIP_SEVENTH}"
                        VERIFY_DIR="~/verify-dir-0084"

                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" "cat $VERIFY_DIR/README.md" 2>/dev/null || echo "FAIL")
                        HAS_MAIN=$(echo "$OUT" | grep -qi "main branch" && echo OK || echo NO)
                        HAS_FEAT=$(echo "$OUT" | grep -qi "feature branch" && echo OK || echo NO)

                        if [[ "$HAS_MAIN" == "OK" && "$HAS_FEAT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: README.md content is not merged correctly"
                        fi


                # ===================== OSADM-QUIZ-009-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-009-1" && "$KEY" == "osadm-quiz-009-1-curl-check" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        # Konsisten dengan Quiz 008: IP ke-7 dari range (59 + 6 = 65)
                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST1="ubuntu@172.20.10.${FIP_SEVENTH}"

                        CLEAN_ID=$(echo "$SUFFIX" | tr '-' ' ')
                        EXPECT_STR="Hi we are from $CLEAN_ID in quiz-009-1"

                        OUT1=$(ssh -n -o StrictHostKeyChecking=no "$HOST1" "curl -s --max-time 5 http://localhost:8081 || echo FAIL")

                        if echo "$OUT1" | grep -qi "$EXPECT_STR"; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Web content mismatch or port 8081 inaccessible. Expected: '$EXPECT_STR' on $HOST1"
                        fi

                # ===================== OSADM-010-2 =====================
                elif [[ "$LAB_ID" == "OSADM-010-2" && "$KEY" == "osadm-010-2-curl-check" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST1="ubuntu@172.20.10.${FIP_SEVENTH}"

                        FIP_EIGHTH=$((FIP_RANGE_START_INT + 7))
                        HOST2="ubuntu@172.20.10.${FIP_EIGHTH}"

                        CLEAN_ID=$(echo "$SUFFIX" | tr '-' ' ')
                        EXPECT_STR="Hi we are from $CLEAN_ID in Production"

                        OUT1=$(ssh -n -o StrictHostKeyChecking=no "$HOST1" "curl -s --max-time 5 http://localhost:8082 || echo FAIL")
                        OUT2=$(ssh -n -o StrictHostKeyChecking=no "$HOST2" "curl -s --max-time 5 http://localhost:8082 || echo FAIL")

                        if echo "$OUT1" | grep -qi "$EXPECT_STR" && echo "$OUT2" | grep -qi "$EXPECT_STR"; then
                                DATA["$KEY"]="exists"
                        else
                                ERR_MSG="Error: Content mismatch."
                                echo "$OUT1" | grep -qi "$EXPECT_STR" || ERR_MSG="$ERR_MSG Node1(Staging) FAIL."
                                echo "$OUT2" | grep -qi "$EXPECT_STR" || ERR_MSG="$ERR_MSG Node2(Production) FAIL."
                                DATA["$KEY"]="$ERR_MSG"
                        fi

                # ===================== OSADM-QUIZ-010-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-010-1" && "$KEY" == "osadm-quiz-010-1-curl-check" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        # Node 1: IP ke-7 dari range (Guru: 59 + 6 = 65)
                        FIP_SEVENTH=$((FIP_RANGE_START_INT + 6))
                        HOST1="ubuntu@172.20.10.${FIP_SEVENTH}"

                        # Node 2: IP ke-8 dari range (Guru: 59 + 7 = 66)
                        FIP_EIGHTH=$((FIP_RANGE_START_INT + 7))
                        HOST2="ubuntu@172.20.10.${FIP_EIGHTH}"

                        CHECK_NODE1=$(ssh -n -o StrictHostKeyChecking=no "$HOST1" "curl -sf --connect-timeout 3 http://localhost:8083 >/dev/null && echo OK || echo FAIL" 2>/dev/null)
                        CHECK_NODE2=$(ssh -n -o StrictHostKeyChecking=no "$HOST2" "curl -sf --connect-timeout 3 http://localhost:8083 >/dev/null && echo OK || echo FAIL" 2>/dev/null)

                        if [[ "$CHECK_NODE1" == "OK" && "$CHECK_NODE2" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                ERR_MSG="Error:"
                                [[ "$CHECK_NODE1" != "OK" ]] && ERR_MSG="$ERR_MSG Node1(8083) Down."
                                [[ "$CHECK_NODE2" != "OK" ]] && ERR_MSG="$ERR_MSG Node2(8083) Down."
                                DATA["$KEY"]="$ERR_MSG"
                        fi

                # ===================== OSADM-011-2 =====================
                elif [[ "$LAB_ID" == "OSADM-011-2" && "$KEY" == "monitoring_quiz_ok" ]]; then
                    FILE="$HOME/monitoring-lab-quiz-1.txt"

                    if [[ ! -f "$FILE" ]]; then
                        DATA["$KEY"]="Error: File tidak ditemukan"
                    else
                        S1=$(grep -A1 "^Soal 1$" "$FILE" | tail -1)
                        S2=$(grep -A1 "^Soal 2$" "$FILE" | tail -1)
                        S3=$(grep -A1 "^Soal 3$" "$FILE" | tail -1)

                        if [[ "$S1" == "d. Jumlah domain/VM yang sedang berjalan (running)." && \
                              "$S2" == "a. Persentase penggunaan memori VM (guest memory usage percent)." && \
                              "$S3" == "b. Persentase penggunaan vCPU rata-rata per vCPU terhadap total alokasi vCPU VM." ]]; then
                            DATA["$KEY"]="exists"
                        else
                            DATA["$KEY"]="Error: Jawaban salah"
                        fi
                    fi

                # ===================== OSADM-011-3 =====================
                elif [[ "$LAB_ID" == "OSADM-011-3" && "$KEY" == "monitoring_quiz_ok" ]]; then
                    FILE="$HOME/monitoring-lab-quiz-2.txt"

                    if [[ ! -f "$FILE" ]]; then
                        DATA["$KEY"]="Error: File tidak ditemukan"
                    else
                        S1=$(grep -A1 "^Soal 1$" "$FILE" | tail -1)
                        S2=$(grep -A1 "^Soal 2$" "$FILE" | tail -1)
                        S3=$(grep -A1 "^Soal 3$" "$FILE" | tail -1)

                        if [[ "$S1" == "c. Menghitung rata-rata pemakaian CPU per VM, dengan melihat kecepatan penggunaan vCPU dalam 5 menit terakhir." && \
                              "$S2" == "b. Menghitung jumlah vCPU yang dimiliki setiap VM." && \
                              "$S3" == "a. Membagi rata-rata pemakaian vCPU per VM dengan jumlah vCPU lalu mengubah hasilnya ke persen." ]]; then
                            DATA["$KEY"]="exists"
                        else
                            DATA["$KEY"]="Error: Jawaban salah"
                        fi
                    fi

                # ===================== gampang =====================
                elif [[ "$LAB_ID" == "gampang" ]]; then
                    SUFFIX="$EXPECTED_SUFFIX"

                    if [[ "$KEY" == "image_name_oks" ]]; then
                        EXPECTED_IMAGE_NAME="ubuntu24.04-quiz003-1-${SUFFIX}"
                        OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                        if echo "$OUTPUT" | grep -Fxq "$EXPECTED_IMAGE_NAME"; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: image '$EXPECTED_IMAGE_NAME' not found"
                        fi
                    fi

                # ===================== OSADM-CH-1 =====================
                elif [[ "$LAB_ID" == "OSADM-CH-1" ]]; then
                    # 1. Definisikan Suffix (Identitas Kelompok)
                    # Diambil dari variable global saat user login
                    SUFFIX="$EXPECTED_SUFFIX"              # Hasilnya: kelompokx-sijax
                    SUFFIX_CLEAN=$(echo "$SUFFIX" | tr -d '-') # Hasilnya: kelompokxsijax

                    # 2. Hitung IP Staging (IP ke-7) dan Production (IP ke-8)
                    # FIP_RANGE_START_INT didapat dari logika penentuan range sebelumnya
                    IP_STAGING="172.20.10.$((FIP_RANGE_START_INT + 6))"
                    IP_PRODUCTION="172.20.10.$((FIP_RANGE_START_INT + 7))"

                    if [[ "$KEY" == "web_staging_ok" ]]; then
                        # Cek apakah web di Node 1 bisa diakses port 80
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "http://$IP_STAGING")
                        if [[ "$HTTP_CODE" == "200" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="FAIL (HTTP $HTTP_CODE)"
                        fi

                    elif [[ "$KEY" == "web_production_ok" ]]; then
                        # Cek apakah web di Node 2 bisa diakses port 80
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "http://$IP_PRODUCTION")
                        if [[ "$HTTP_CODE" == "200" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="FAIL (HTTP $HTTP_CODE)"
                        fi

                    elif [[ "$KEY" == "volume_attached_ok" ]]; then
                        # 1. Cek OpenStack: Volume status must be 'in-use'
                        VOL_NAME="db-volume-${SUFFIX_CLEAN}"
                        VOL_STATUS=$(openstack volume show "$VOL_NAME" -f value -c status 2>/dev/null)

                        # 2. Cek OS: SSH ke Node 2, pastikan ter-mount di /mnt/cinder-db
                        MOUNT_CHECK=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$IP_PRODUCTION" "lsblk | grep -q '/mnt/cinder-db' && echo OK" 2>/dev/null)

                        if [[ "$VOL_STATUS" == "in-use" && "$MOUNT_CHECK" == "OK" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="FAIL (Volume: $VOL_STATUS, Mount: $MOUNT_CHECK)"
                        fi

                    elif [[ "$KEY" == "container_inventaris_ok" ]]; then
                        # Cek container app di Node 1 via SSH
                        # Pakai sudo untuk menghindari permission denied docker.sock
                        C_NAME="inventaris-${SUFFIX}"
                        CHECK=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$IP_STAGING" "sudo docker ps --filter 'name=$C_NAME' --format '{{.Names}}' | grep -q '$C_NAME' && echo OK" 2>/dev/null)
                        if [[ "$CHECK" == "OK" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="FAIL (Container $C_NAME not running)"
                        fi

                    elif [[ "$KEY" == "container_db_ok" ]]; then
                        # Cek container database di Node 2 via SSH
                        C_NAME="inventaris-db"
                        CHECK=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$IP_PRODUCTION" "sudo docker ps --filter 'name=$C_NAME' --format '{{.Names}}' | grep -q '$C_NAME' && echo OK" 2>/dev/null)
                        if [[ "$CHECK" == "OK" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="FAIL (Container $C_NAME not running)"
                        fi
                    fi

		## ===================== OSADM-001-2 (CLI – CirrOS, 512MB) =====================
		elif [[ "$LAB_ID" == "OSADM-001-2" ]]; then
			SUFFIX="$EXPECTED_SUFFIX"
			SUFFIX_CLEAN=$(echo "$SUFFIX" | tr -d '-')   # kelompok2-sija1 -> kelompok2sija1

			if [[ "$KEY" == "image_name_ok" ]]; then
				# cirros-lab001-2-kelompok2sija1
				EXPECTED_IMAGE_NAME="cirros-lab001-2-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_IMAGE_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: image '$EXPECTED_IMAGE_NAME' not found"
				fi

			elif [[ "$KEY" == "flavor_name_ok" ]]; then
				# fl-lab001-2-kelompok2sija1
				EXPECTED_FLAVOR_NAME="fl-lab001-2-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_FLAVOR_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: flavor '$EXPECTED_FLAVOR_NAME' not found"
				fi

			elif [[ "$KEY" == "flavor_spec_ok" ]]; then
				# spesifikasi: 1 vCPU, 512 MB RAM, 4 GB disk
				EXPECTED_FLAVOR_NAME="fl-lab001-2-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack flavor show "$EXPECTED_FLAVOR_NAME" -f json 2>/dev/null || echo "{}")
				RAM=$(echo "$OUTPUT" | jq -r '.ram // empty')
				DISK=$(echo "$OUTPUT" | jq -r '.disk // empty')
				VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')

				REQ_RAM="512"

				if [[ "$RAM" == "$REQ_RAM" && "$DISK" == "4" && "$VCPUS" == "1" ]]; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: spec mismatch (Got RAM:$RAM DISK:$DISK VCPU:$VCPUS, Expected RAM:$REQ_RAM DISK:4 VCPU:1)"
				fi

			elif [[ "$KEY" == "keypair_name_ok" ]]; then
				# key-lab001-2-kelompok2sija1
				EXPECTED_KEYPAIR_NAME="key-lab001-2-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_KEYPAIR_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: keypair '$EXPECTED_KEYPAIR_NAME' not found"
				fi
			fi

                ## ===================== OSADM-001-3 (GUI - 1024MB) =====================
                elif [[ "$LAB_ID" == "OSADM-001-3" ]]; then
                        SUFFIX="$EXPECTED_SUFFIX"

                        if [[ "$KEY" == "image_name_ok" ]]; then
                                EXPECTED_IMAGE_NAME="ubuntu24-horizon-${SUFFIX}"
                                OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$EXPECTED_IMAGE_NAME"; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: image '$EXPECTED_IMAGE_NAME' not found"
                                fi

                        elif [[ "$KEY" == "flavor_name_ok" ]]; then
                                EXPECTED_FLAVOR_NAME="fl-horizon-${SUFFIX}"
                                OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$EXPECTED_FLAVOR_NAME"; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: flavor '$EXPECTED_FLAVOR_NAME' not found"
                                fi

                        elif [[ "$KEY" == "flavor_spec_ok" ]]; then
                                EXPECTED_FLAVOR_NAME="fl-horizon-${SUFFIX}"
                                OUTPUT=$(openstack flavor show "$EXPECTED_FLAVOR_NAME" -f json 2>/dev/null || echo "{}")
                                RAM=$(echo "$OUTPUT" | jq -r '.ram // empty')
                                DISK=$(echo "$OUTPUT" | jq -r '.disk // empty')
                                VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')
                                REQ_RAM="1024"

                                if [[ "$RAM" == "$REQ_RAM" && "$DISK" == "4" && "$VCPUS" == "1" ]]; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: spec mismatch (Got RAM:$RAM DISK:$DISK VCPU:$VCPUS, Expected RAM:$REQ_RAM DISK:4 VCPU:1)"
                                fi

                        elif [[ "$KEY" == "keypair_name_ok" ]]; then
                                EXPECTED_KEYPAIR_NAME="key-horizon-${SUFFIX}"
                                OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                                if echo "$OUTPUT" | grep -Fxq "$EXPECTED_KEYPAIR_NAME"; then
                                        DATA["$KEY"]="OK"
                                else
                                        DATA["$KEY"]="Error: keypair '$EXPECTED_KEYPAIR_NAME' not found"
                                fi
                        fi

		## ===================== OSADM-001-3 (GUI - 1024MB) =====================
		elif [[ "$LAB_ID" == "OSADM-001-3" ]]; then
			SUFFIX="$EXPECTED_SUFFIX"
			SUFFIX_CLEAN=$(echo "$SUFFIX" | tr -d '-')   # kelompok2-sija1 -> kelompok2sija1

			if [[ "$KEY" == "image_name_ok" ]]; then
				# ubuntu24-horizon-kelompokXsijaX  (tanpa ekstra '-')
				EXPECTED_IMAGE_NAME="ubuntu24-horizon-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_IMAGE_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: image '$EXPECTED_IMAGE_NAME' not found"
				fi

			elif [[ "$KEY" == "flavor_name_ok" ]]; then
				# fl-horizon-kelompokXsijaX
				EXPECTED_FLAVOR_NAME="fl-horizon-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_FLAVOR_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: flavor '$EXPECTED_FLAVOR_NAME' not found"
				fi

			elif [[ "$KEY" == "flavor_spec_ok" ]]; then
				# spesifikasi: 1 vCPU, 1024 MB RAM, 4 GB disk
				EXPECTED_FLAVOR_NAME="fl-horizon-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack flavor show "$EXPECTED_FLAVOR_NAME" -f json 2>/dev/null || echo "{}")
				RAM=$(echo "$OUTPUT" | jq -r '.ram // empty')
				DISK=$(echo "$OUTPUT" | jq -r '.disk // empty')
				VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')
				REQ_RAM="1024"

				if [[ "$RAM" == "$REQ_RAM" && "$DISK" == "4" && "$VCPUS" == "1" ]]; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: spec mismatch (Got RAM:$RAM DISK:$DISK VCPU:$VCPUS, Expected RAM:$REQ_RAM DISK:4 VCPU:1)"
				fi

			elif [[ "$KEY" == "keypair_name_ok" ]]; then
				# key-horizon-kelompokXsijaX
				EXPECTED_KEYPAIR_NAME="key-horizon-${SUFFIX_CLEAN}"
				OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
				if echo "$OUTPUT" | grep -Fxq "$EXPECTED_KEYPAIR_NAME"; then
					DATA["$KEY"]="OK"
				else
					DATA["$KEY"]="Error: keypair '$EXPECTED_KEYPAIR_NAME' not found"
				fi
			fi

#                else
                        # 1. Pastikan variabel pendukung sudah tersedia secara lokal
                        SUFFIX="$EXPECTED_SUFFIX"

                        # Menentukan Floating IP (FIP) secara dinamis jika belum didefinisikan secara manual
                        FLOATINGIP="172.20.10.${FIP_RANGE_START_INT}"

                        # X_INT biasanya merujuk pada octet internal (192.30.X.0)
                        X_INT="$EXPECTED_INTERNAL_OCTET"

                        # 2. Transformasi Template Perintah
                        CMD=$(echo "$CMD_TEMPLATE" | sed \
                                -e "s/PLACEHOLDER/${SUFFIX}/g" \
                                -e "s/FIP_PLACEHOLDER/${FLOATINGIP}/g" \
                                -e "s/X_INT/${X_INT}/g")

                        # 3. Eksekusi dan Verifikasi
                        OUTPUT=$(eval "$CMD" 2>&1)

                        if echo "$OUTPUT" | grep -q "$EXPECTED"; then
                                DATA["$KEY"]="OK"
                        else
                                DATA["$KEY"]="Error: expected '$EXPECTED' not found on output of: $CMD"
                        fi
                fi
                ;;

            file_content)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                CONTAINS=$(echo "$criterion" | jq -r '.contains')
                echo "Checking file: $FILE_PATH"
                if [[ -f "$FILE_PATH" ]]; then
                    CONTENT=$(cat "$FILE_PATH" 2>/dev/null || echo "")
                    echo "File content: $CONTENT"
                    if [[ "$CONTENT" == *"$CONTAINS"* ]]; then
                        DATA["$KEY"]="contains"
                    else
                        DATA["$KEY"]="Error: Content not found"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            service)
                SERVICE_NAME=$(echo "$criterion" | jq -r '.service')
                if systemctl is-active --quiet "$SERVICE_NAME"; then
                    DATA["$KEY"]="active"
                else
                    DATA["$KEY"]="Error: Service not active"
                fi
                ;;
            directory)
                DIR_PATH=$(echo "$criterion" | jq -r '.path')
                if [[ -d "$DIR_PATH" ]]; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Directory not found"
                fi
                ;;
            config_check)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                PARAMETER=$(echo "$criterion" | jq -r '.parameter')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')
                if [[ -f "$FILE_PATH" ]]; then
                    if [[ "$PARAMETER" == "owner" ]]; then
                        OWNER=$(stat -c "%U" "$FILE_PATH")
                        if [[ "$OWNER" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect owner"
                        fi
                    elif [[ "$PARAMETER" == "group" ]]; then
                        GROUP=$(stat -c "%G" "$FILE_PATH")
                        if [[ "$GROUP" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect group"
                        fi
                    elif [[ "$PARAMETER" == "permissions" ]]; then
                        PERM=$(stat -c "%A" "$FILE_PATH")
                        PERM=${PERM:1}
                        if [[ "$PERM" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect permissions"
                        fi
                    else
                        DATA["$KEY"]="Error: Invalid parameter"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            package)
                PACKAGE_NAME=$(echo "$criterion" | jq -r '.name')
                if dpkg -l | grep -q "^ii  $PACKAGE_NAME "; then
                    DATA["$KEY"]="installed"
                else
                    DATA["$KEY"]="Error: Package not installed"
                fi
                ;;
            user)
                USER_NAME="$KEY"
                if id "$USER_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: User not found"
                fi
                ;;
            group)
                GROUP_NAME=$(echo "$criterion" | jq -r '.name')
                if getent group "$GROUP_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Group not found"
                fi
                ;;
            instance)
                GROUP_NAME=$(echo "$criterion" | jq -r '.name')
                if getent group "$GROUP_NAME" &>/dev/null; then
                    DATA["$KEY"]="deleted"
                else
                    DATA["$KEY"]="Error: Instance found"
                fi
                ;;
            image)
                IMAGE_NAME="$KEY"
                SUFFIX="EXPECTED_SUFFIX"
                # Menggunakan offset IP ke-7 (START + 6) untuk git-node1
                FIP_GIT_NODE=$((FIP_RANGE_START_INT + 6))
                HOST="ubuntu@172.20.10.${FIP_GIT_NODE}"

                # ===================== OSADM-009-2 =====================
                if [[ "$LAB_ID" == "OSADM-009-2" && "$KEY" == "lab1shell-kelompokx-sijax:latest" ]]; then
                        DYNAMIC_IMG="lab1shell-${SUFFIX}:latest"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" \
                                "docker image inspect $DYNAMIC_IMG >/dev/null 2>&1 && echo OK || echo NOT_FOUND")
                        if [[ "$OUT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Image $DYNAMIC_IMG not found on git-node1 ($HOST)"
                        fi

                # ===================== OSADM-009-3 =====================
                elif [[ "$LAB_ID" == "OSADM-009-3" && "$KEY" == "web-kelompokx-sijax:latest" ]]; then
                        DYNAMIC_IMG="web-${SUFFIX}:latest"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" \
                                "docker image inspect $DYNAMIC_IMG >/dev/null 2>&1 && echo OK || echo NOT_FOUND")
                        if [[ "$OUT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Image $DYNAMIC_IMG not found on $HOST"
                        fi

                # ===================== OSADM-QUIZ-009-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-009-1" && "$KEY" == "quiz9-web-kelompokxsijax:latest" ]]; then
                        CLEAN_SUFFIX=$(echo "$SUFFIX" | tr -d '-')
                        DYNAMIC_IMG="quiz9-web-${CLEAN_SUFFIX}:latest"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" \
                                "docker image inspect $DYNAMIC_IMG >/dev/null 2>&1 && echo OK || echo NOT_FOUND")
                        if [[ "$OUT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Image $DYNAMIC_IMG not found on $HOST"
                        fi

                # ===================== OSADM-QUIZ-010-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-010-1" && "$KEY" == "game-kelompokx-sijax" ]]; then
                        DYNAMIC_IMG="game-${SUFFIX}"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" \
                                "docker image ls --format '{{.Repository}}' | grep -q '$DYNAMIC_IMG' && echo OK || echo NOT_FOUND")
                        if [[ "$OUT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Image $DYNAMIC_IMG not found on $HOST"
                        fi

                # ===================== OSADM-010-2 =====================
                elif [[ "$LAB_ID" == "OSADM-010-2" && "$KEY" == "prod-ci-kelompokx-sijax" ]]; then
                        DYNAMIC_IMG="prod-ci-${SUFFIX}"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "$HOST" \
                                "docker image ls --format '{{.Repository}}' | grep -q '$DYNAMIC_IMG' && echo OK || echo NOT_FOUND")
                        if [[ "$OUT" == "OK" ]]; then
                                DATA["$KEY"]="exists"
                        else
                                DATA["$KEY"]="Error: Image $DYNAMIC_IMG not found on $HOST"
                        fi

                # ===================== OSADM-CH-1 - CEK IMAGE DI NODE1 =====================
                elif [[ "$LAB_ID" == "OSADM-CH-1" && "$TYPE" == "image" ]]; then
                    # 1. Pastikan Suffix Terdefinisi (Sesuai User Login)
                    #    Gunakan variabel GROUP_NUM dan CLASS_TYPE yang sudah ada di environment gradingctl
                    SUFFIX="kelompok${GROUP_NUM}-sija${CLASS_TYPE}"

                    # 2. Tentukan IP Node 1 (IP ke-7)
                    #    FIP_RANGE_START_INT adalah awal range (Contoh: 69 untuk SIJA 1)
                    IP_NODE1="172.20.10.$((FIP_RANGE_START_INT + 6))"

                    # 3. Logika Pengecekan (struktur sama seperti OSADM-010-2)
                    if [[ "$KEY" == "inventaris-kelompokx-sijax" || "$KEY" == "inventaris-${SUFFIX}" ]]; then
                        IMAGE_TO_CHECK="inventaris-${SUFFIX}"
                        OUT=$(ssh -n -o StrictHostKeyChecking=no "ubuntu@$IP_NODE1" \
                            "docker image ls --format '{{.Repository}}' | grep -E '(^|/)$IMAGE_TO_CHECK$' && echo OK || echo NOT_FOUND" 2>/dev/null)
                        if [[ "$OUT" == "OK" || "$OUT" == *"OK"* ]]; then
                            DATA["$KEY"]="exists"
                        else
                            DATA["$KEY"]="Error: Image $IMAGE_TO_CHECK tidak ditemukan di Node 1 ($IP_NODE1)"
                        fi
                    fi


                else
                    # default: cek di host lokal
                    if docker image ls --format '{{.Repository}}:{{.Tag}}' | grep -qx "$IMAGE_NAME"; then
                        DATA["$KEY"]="exists"
                    else
                        DATA["$KEY"]="Error: $IMAGE_NAME not found"
                    fi
                fi
                ;;
            *)
            if [[ "$TYPE" == "gitlab_project" || "$TYPE" == "gitlab_pipeline" || \
                  "$TYPE" == "gitlab_runner" || "$TYPE" == "grafana_alert_rule" || \
                  "$TYPE" == "grafana_alert_firing" || "$TYPE" == "gmail_alert_email" ]]; then
                # tipe ini dicek di server, agent cukup skip
                if [[ -z "$KEY" ]]; then
                    KEY="$TYPE"
                fi
                DATA["$KEY"]=""    # atau isi kosong
            else
                echo "Unsupported criterion type: $TYPE"
                exit 1
            fi
            ;;
        esac
    done < <(echo "$SCHEME" | jq -c '.criteria[]')

    CLIENT_DATA=$(jq -n \
        --arg lab_id "$LAB_ID" \
        --arg class_name "$CLASS_NAME" \
        '{
            lab_id: $lab_id,
            class_name: $class_name,
            client_data: {}
        }')

#    echo "=== DEBUG CONFIG ==="
#    echo "X_INT: $X_INT"
#    echo "FL_PREFIX: $FL_PREFIX"
#    echo "ROUTER_IP: $ROUTER_IP"
#    echo "FLOATINGIP: $FLOATINGIP"
#    echo "===================="

#    echo "DEBUG: Sedang memproses key -> $KEY untuk Lab -> $LAB_ID"

#    echo "=== DEBUG DATA for $LAB_ID ==="
#    for key in "${!DATA[@]}"; do
#        echo "$key => ${DATA[$key]}"
#    done
#    echo "=============================="#

    for key in "${!DATA[@]}"; do
        value="${DATA[$key]}"
        CLIENT_DATA=$(printf '%s\n' "$CLIENT_DATA" | \
            jq --arg k "$key" --arg v "$value" '.client_data[$k] = $v')
    done

    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "$CLIENT_DATA" \
        "$SERVER_URL/grade-lab")

    print_grading_result "$LAB_ID" "$RESPONSE"
}

function list_labs() {
    RESPONSE=$(curl -s -X GET "$SERVER_URL/list-labs")

    LABS=$(echo "$RESPONSE" | jq -r '.labs[] | "\(.lab_id): \(.scheme_path)"')
    if [[ -z "$LABS" ]]; then
        echo "No labs found"
    else
        echo "Available Labs:"
        echo "$LABS"
    fi
}

function print_grading_result() {
    LAB_ID=$1
    RESPONSE=$2

    LOG_DIR="/var/log/gradingctl/labs"
    LOG_TXT_FILE="$LOG_DIR/${LAB_ID}.log"

    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR" 2>/dev/null
    fi



#    sudo mkdir -p "$LOG_DIR"
#    sudo chown -R "$USER:$USER" /var/log/gradingctl
#    sudo chmod 755 /var/log/gradingctl
#    sudo chmod 755 "$LOG_DIR"

    #: > "$LOG_TXT_FILE"

    ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error // empty')
    if [[ -n "$ERROR_MSG" ]]; then
        echo -e "${RED}[-] Grading lab -> $LAB_ID${NC}"
        echo -e "${RED}[x] Error: $ERROR_MSG${NC}"
        return
    fi

    FEEDBACK=$(echo "$RESPONSE" | jq -c '.feedback // []')
    SCORE=$(echo "$RESPONSE" | jq -r '.score // 0')
    SCORE_INT=$(printf "%.0f" "$SCORE" 2>/dev/null || echo 0)

    RAW_DURATION=$(echo "$RESPONSE" | jq -r '.duration // 0')
    # normalisasi ke integer detik
    RAW_DURATION_INT=$(printf "%.0f" "$RAW_DURATION" 2>/dev/null || echo 0)

    if [[ "$RAW_DURATION_INT" -gt 0 ]]; then
        # kalau server sudah kirim duration (detik), pakai itu
        DURATION=$(( (RAW_DURATION_INT + 59) / 60 ))
    else
        # fallback: hitung sendiri dari file start
        START_FILE="$HOME/.grading_start_${LAB_ID}"
        if [[ -f "$START_FILE" ]]; then
            START_TS=$(cat "$START_FILE")
            NOW_TS=$(date +%s)
            ELAPSED_SEC=$((NOW_TS - START_TS))
            DURATION=$(( (ELAPSED_SEC + 59) / 60 ))
        else
            DURATION=0
        fi
    fi

    mapfile -t FEEDBACK_LINES < <(echo "$FEEDBACK" | jq -r '.[]')

#    for feedback_msg in "${FEEDBACK_LINES[@]}"; do
#        if [[ "$feedback_msg" == *": Failed" ]]; then
#            NOW=$(date '+%Y-%m-%d %H:%M:%S')
#            echo "[$NOW] CASE: ${feedback_msg%: Failed} | ERROR: Failed" >> "$LOG_TXT_FILE"
#        fi
#    done

    echo -e "${NC}[-] Grading lab -> $LAB_ID${NC}"

    local i=1
    local has_failed=0
    for feedback_msg in "${FEEDBACK_LINES[@]}"; do
        if [[ "$feedback_msg" == *": Failed" ]]; then
            has_failed=1
            case_name="${feedback_msg%: Failed}"
            echo -e "${RED}    => case $i - $case_name [x]${NC}"
        else
            echo -e "${GREEN}    => case $i - $feedback_msg [✓]${NC}"
        fi
        ((i++))
    done

    if [[ "$has_failed" -eq 1 ]]; then
        echo -e "${RED}[x] Gagal! Task belum lengkap${NC}"
        echo -e "${YELLOW}[!] Hint: cek gradingctl fetch-log $LAB_ID${NC}"
        echo -e "${YELLOW}[!] Atau open the log file at: $LOG_TXT_FILE${NC}"
    fi

    echo -e "${NC}[-] Time -> $DURATION menit"
    echo -e "${NC}[-] Score -> $SCORE${NC}"

    if [[ "$SCORE_INT" -eq 100 ]]; then
        echo -e "${GREEN}[✓] Congratulations! You've completed the task!${NC}"
    else
        echo -e "${GREEN}[✓] Don't worry, we keep your higher score${NC}"
    fi
}

function finish() {
    TOKEN_FILE="$HOME/.nusactl_token"
    TOKEN=$(cat "$TOKEN_FILE" 2>/dev/null)
    LAB_ID=$1

    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Usage: gradingctl finish <lab_id>${NC}"
        return
    fi

    # 1. Identitas Dinamis (Jalan di background)
    EXTRACTED_USER=$(echo "$TOKEN" | cut -d'-' -f3)
    USER_DATA=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" "$SERVER_URL/get-users-and-labs")

    RAW_GROUP=$(echo "$USER_DATA" | jq -r ".users[] | select(.username==\"$EXTRACTED_USER\") | .group_name" | head -n 1)
    RAW_CLASS=$(echo "$USER_DATA" | jq -r ".users[] | select(.username==\"$EXTRACTED_USER\") | .class_name" | head -n 1)

    G_VAL=$(echo "$RAW_GROUP" | tr '[:upper:]' '[:lower:]' | sed 's/kelompok//g' | tr -d ' ')
    C_VAL=$(echo "$RAW_CLASS" | tr '[:upper:]' '[:lower:]' | sed 's/sija//g' | tr -d ' ')

    EXPECTED_SUFFIX="kel${G_VAL}sija${C_VAL}"
    LONG_G_DASH="kelompok${G_VAL}-sija${C_VAL}"
    LONG_G_NO_DASH="kelompok${G_VAL}sija${C_VAL}"

    # 2. Source RC (Silent)
    if [[ "$G_VAL" == "x" ]]; then
        RC_FILE="$HOME/${EXPECTED_SUFFIX}_admin.sh"
        [[ ! -f "$RC_FILE" ]] && RC_FILE="$HOME/${EXPECTED_SUFFIX}_admin.sh"
    else
        RC_FILE="$HOME/${EXPECTED_SUFFIX}_admin-rc.sh"
        [[ ! -f "$RC_FILE" ]] && RC_FILE="$HOME/${EXPECTED_SUFFIX}_admin-rc.sh"
    fi

    if [[ -f "$RC_FILE" ]]; then
        source /opt/kolla-ansible/venv/bin/activate >/dev/null 2>&1
        source "$RC_FILE" >/dev/null 2>&1
    else
        return
    fi

    # 3. Daftar Template
    declare -a TARGET_VMS
    declare -a TARGET_STACKS
    case $LAB_ID in
        "OSADM-004-2") TARGET_VMS=("cirros-cli-kelompokx-sijax") ;;
        "OSADM-004-3") TARGET_VMS=("noble-horizon-ins-kelompokx-sijax") ;;
        "OSADM-004-4") TARGET_VMS=("vm2048rescue-kelompokx-sijax") ;;
        "quiz-004-1" | "OSADM-QUIZ-004-1") TARGET_VMS=("2048-quiz003-1-kelompokx-sijax") ;;
        "OSADM-QUIZ-005-1")
            TARGET_STACKS=("instance-stack-kelompokx-sijax")
            TARGET_VMS=("haproxy-kelompokx-sijax" "backend1-kelompokx-sijax" "backend2-kelompokx-sijax")
            ;;
        *)
            TARGET_STACKS=("instance-stack-kelompokx-sijax")
            SCHEME_RESP=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" "$SERVER_URL/get-scheme?lab_id=$LAB_ID")
            TARGET_VMS=($(echo "$SCHEME_RESP" | jq -r '.scheme.criteria[] | select(.cleanup==true and .type=="instance") | .key'))
            ;;
    esac

    # 4. Hapus Stack (Silent)
    for STACK_TEMPLATE in "${TARGET_STACKS[@]}"; do
        S_VAR1=$(echo "$STACK_TEMPLATE" | sed "s/kelompokx-sijax/$EXPECTED_SUFFIX/g")
        S_VAR2=$(echo "$STACK_TEMPLATE" | sed "s/kelompokx-sijax/$LONG_G_DASH/g")
        openstack stack delete "$S_VAR1" --wait --yes >/dev/null 2>&1
        openstack stack delete "$S_VAR2" --wait --yes >/dev/null 2>&1
    done

    # 5. Hapus VM (Silent)
    for TEMPLATE in "${TARGET_VMS[@]}"; do
        [[ -z "$TEMPLATE" || "$TEMPLATE" == "null" ]] && continue
        V1=$(echo "$TEMPLATE" | sed "s/kelompokx-sijax/$EXPECTED_SUFFIX/g")
        V2=$(echo "$TEMPLATE" | sed "s/kelompokx-sijax/$LONG_G_NO_DASH/g")
        V3=$(echo "$TEMPLATE" | sed "s/kelompokx-sijax/$LONG_G_DASH/g")
        openstack server delete "$V1" --wait >/dev/null 2>&1
        openstack server delete "$V2" --wait >/dev/null 2>&1
        openstack server delete "$V3" --wait >/dev/null 2>&1
        openstack server delete "$TEMPLATE" --wait >/dev/null 2>&1
    done

    # 6. Lapor API & Tampilkan Hasil Saja
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/finish-lab")

    # Ambil pesan sukses saja
    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
    echo -e "${GREEN}${MESSAGE}${NC}"

    rm -f "$ACTIVE_LAB_FILE"
    deactivate >/dev/null 2>&1
}

function logout() {
    if [[ -f ~/.nusactl_token ]]; then
        rm ~/.nusactl_token
        echo -e "${GREEN}Logged out successfully.${NC}"
    else
        echo -e "${YELLOW}No active session found.${NC}"
    fi
}

function fetch_log() {
    LAB_ID=$1
    LOG_FILE="/var/log/gradingctl/labs/${LAB_ID}.log"
    if [[ -f "$LOG_FILE" ]]; then
        cat "$LOG_FILE"
    else
        echo "Log file not found for lab: $LAB_ID"
    fi
}

function reset_password() {
    echo -n "Username: "; read username
    echo -n "Email / No Telp: "; read identity
    echo -n "Password Baru: "; read -s new_password; echo ""
    echo -n "Retype Password Baru: "; read -s confirm_password; echo ""

    if [ "$new_password" != "$confirm_password" ]; then
        echo -e "\033[31mError: Password tidak cocok!\033[0m"
        return
    fi

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
        -d "{\"username\":\"$username\",\"identity\":\"$identity\",\"new_password\":\"$new_password\"}" \
        $SERVER_URL/reset_password)

    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
    ERROR=$(echo "$RESPONSE" | jq -r '.error')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "\033[31mError: $ERROR\033[0m"
    else
        echo -e "\033[32mSuccess: $MESSAGE\033[0m"
    fi
}

#function fetch_log() {
#    TOKEN=$(cat ~/.nusactl_token)
#    LAB_ID=$1
#    SERVER_URL="10.10.10.12:5000"
#    RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$SERVER_URL/get-log?lab_id=$LAB_ID")
#    LOG_CONTENT=$(echo "$RESPONSE" | jq -r '.content // .error')
#    echo "$LOG_CONTENT"
#}

function help() {
    echo -e "${BLUE}Usage: gradingctl {command} [options]${NC}"
    echo -e "${BLUE}Commands:${NC}"
    echo -e "  ${GREEN}login${NC}       - Login to the system"
    echo -e "  ${GREEN}register${NC}    - Register a new user"
    echo -e "  ${GREEN}start${NC}       - Start a lab (usage: start <lab_id> [-s|-f])"
    echo -e "  ${GREEN}grade${NC}       - Grade a lab (usage: grade <lab_id>)"
    echo -e "  ${GREEN}finish${NC}      - Finish a lab (usage: finish <lab_id>)"
    echo -e "  ${GREEN}logout${NC}      - Logout from the system"
    echo -e "  ${GREEN}list-labs${NC}   - List all available labs"
    echo -e "  ${GREEN}-h, --help${NC}  - Show this help message"
    echo -e "${BLUE}Options:${NC}"
    echo -e "  ${YELLOW}-s${NC}         - Show simplified scheme when starting a lab"
    echo -e "  ${YELLOW}-f${NC}         - Save scheme to file when starting a lab"
}

case $1 in
    login) login ;;
    register) register ;;
    reset-password) reset_password ;;
    start) start_lab $2 $3 ;;  # Tambahkan $3 untuk opsi (-s atau -f)
    grade) grade_lab $2 ;;
    finish) finish $2 ;;
    logout) logout ;;
    fetch-log) fetch_log $2 ;;
    list-labs) list_labs ;;
    -h|--help) help ;;
    *) echo "Usage: gradingctl {login|register|start|grade|finish|logout|fetch-log|list-labs|-h|--help}" ;;
esac
