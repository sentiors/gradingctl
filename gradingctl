#!/bin/bash

SERVER_URL="http://10.10.10.12:5000"
ACTIVE_LAB_FILE="/tmp/active_lab"

# Warna ANSI
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

function register() {
    echo -n "Nama: "
    read name
    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo
    echo -n "Grup: "
    read group_name
    echo -n "Kelas: "
    read class_name

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
        -d "{\"username\": \"$username\", \"password\": \"$password\", \"name\": \"$name\", \"class_name\": \"$class_name\", \"group_name\": \"$group_name\"}" \
        $SERVER_URL/register)

    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
    ERROR=$(echo "$RESPONSE" | jq -r '.error')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    else
        echo -e "${GREEN}$MESSAGE${NC}"
    fi
}

function login() {
    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
    -d "{\"username\": \"$username\", \"password\": \"$password\"}" \
    $SERVER_URL/login)

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    TOKEN=$(echo "$RESPONSE" | jq -r '.token')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        if [[ "$ERROR" == "User not exist, please register first (gradingctl register)" ]]; then
            echo -e "${YELLOW}Please register first using: gradingctl register${NC}"
        fi
        exit 1
    elif [[ $TOKEN == "null" || -z $TOKEN ]]; then
        echo -e "${RED}Login failed${NC}"
        exit 1
    else
        echo $TOKEN > ~/.nusactl_token
        echo -e "${GREEN}Login successful${NC}"
    fi
}


function start_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    if [[ -z "$TOKEN" ]]; then
        echo -e "${RED}Error: Token not found. Please login first.${NC}"
        exit 1
    fi

    LAB_ID=$1
    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Error: Lab ID is required.${NC}"
        exit 1
    fi

    # Kirim request ke server
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/start-lab")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Simpan lab yang aktif
    echo "$LAB_ID" > "$ACTIVE_LAB_FILE"
    echo -e "${GREEN}[-] Starting lab -> $LAB_ID${NC}"
    echo -e "${GREEN}[✓] Lab $LAB_ID Started${NC}"

    # Handle opsi -s dan -f
    if [[ "$2" == "-s" ]]; then
        show_simplified_scheme "$LAB_ID"
    elif [[ "$2" == "-f" ]]; then
        save_scheme_to_file "$LAB_ID"
    fi
}

function show_simplified_scheme() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil deskripsi skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme-description?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Tampilkan deskripsi skema yang disederhanakan
    echo -e "${NC}Lab: $LAB_ID${NC}"
    echo -e "${NC}----------------${NC}"
    echo ""
    echo -e "${NC}Tasks:${NC}"
    echo "$RESPONSE" | jq -r '.criteria[] | "- \(.description)"'
}

function save_scheme_to_file() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Ekstrak hanya daftar task (criteria) dari skema
    TASKS=$(echo "$RESPONSE" | jq -c '.scheme.criteria[] | {description: .description}')

    # Simpan daftar task ke file JSON
    SCHEME_FILE="/tmp/${LAB_ID}_scheme.json"
    echo "$TASKS" | jq -s '.' > "$SCHEME_FILE"

    # Tampilkan lokasi file
    echo -e "${GREEN}Scheme saved to: $SCHEME_FILE${NC}"
}

function escape_json() {
    # Escape karakter kontrol dan karakter khusus dalam string JSON
    echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\x00/\\u0000/g' -e 's/\x01/\\u0001/g' \
    -e 's/\x02/\\u0002/g' -e 's/\x03/\\u0003/g' -e 's/\x04/\\u0004/g' -e 's/\x05/\\u0005/g' \
    -e 's/\x06/\\u0006/g' -e 's/\x07/\\u0007/g' -e 's/\x08/\\b/g' -e 's/\x09/\\t/g' \
    -e 's/\x0A/\\n/g' -e 's/\x0B/\\u000B/g' -e 's/\x0C/\\f/g' -e 's/\x0D/\\r/g' \
    -e 's/\x0E/\\u000E/g' -e 's/\x0F/\\u000F/g' -e 's/\x10/\\u0010/g' -e 's/\x11/\\u0011/g' \
    -e 's/\x12/\\u0012/g' -e 's/\x13/\\u0013/g' -e 's/\x14/\\u0014/g' -e 's/\x15/\\u0015/g' \
    -e 's/\x16/\\u0016/g' -e 's/\x17/\\u0017/g' -e 's/\x18/\\u0018/g' -e 's/\x19/\\u0019/g' \
    -e 's/\x1A/\\u001A/g' -e 's/\x1B/\\u001B/g' -e 's/\x1C/\\u001C/g' -e 's/\x1D/\\u001D/g' \
    -e 's/\x1E/\\u001E/g' -e 's/\x1F/\\u001F/g'
}

function grade_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    LAB_ID=$1

    if [[ ! -f "$ACTIVE_LAB_FILE" || $(cat "$ACTIVE_LAB_FILE") != "$LAB_ID" ]]; then
        echo "Error: Lab not started. Please run 'start' first."
        exit 1
    fi

    # Ambil class_name dari token (asumsi class_name disimpan di token)
    CLASS_NAME=$(echo "$TOKEN" | cut -d'-' -f4)  # Sesuaikan dengan format token Anda

    # Ambil skema dari server
    SCHEME_RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
    "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    SCHEME=$(echo "$SCHEME_RESPONSE" | jq -c '.scheme')
    if [[ -z "$SCHEME" || "$SCHEME" == "null" ]]; then
        echo "Error: Failed to fetch scheme for lab $LAB_ID"
        exit 1
    fi

    # Kumpulkan data sesuai skema
    declare -A DATA

    while IFS= read -r criterion; do
        TYPE=$(echo "$criterion" | jq -r '.type')
        KEY=$(echo "$criterion" | jq -r '.key')  # Gunakan 'key' sebagai identifier unik

        case $TYPE in
            command)
                COMMAND=$(echo "$criterion" | jq -r '.command')
                OUTPUT=$(eval "$COMMAND" 2>/dev/null || echo "Error: Command failed")
                # Bersihkan output dari karakter kontrol
                OUTPUT=$(echo "$OUTPUT" | tr -cd '\11\12\15\40-\176')
                DATA["$KEY"]="$OUTPUT"
                ;;
            file_exists)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')
                if [[ "$EXPECTED" == "deleted" ]]; then
                    if [[ ! -f "$FILE_PATH" ]]; then
                        DATA["$KEY"]="deleted"
                    else
                        DATA["$KEY"]="Error: File exists"
                    fi
                else
                    if [[ -f "$FILE_PATH" ]]; then
                        DATA["$KEY"]="exists"
                    else
                        DATA["$KEY"]="Error: File not found"
                    fi
                fi
                ;;
            file_content)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                CONTAINS=$(echo "$criterion" | jq -r '.contains')
                echo "Checking file: $FILE_PATH"
                if [[ -f "$FILE_PATH" ]]; then
                    CONTENT=$(cat "$FILE_PATH" 2>/dev/null || echo "")
                    echo "File content: $CONTENT"
                    if [[ "$CONTENT" == *"$CONTAINS"* ]]; then
                        DATA["$KEY"]="contains"
                    else
                        DATA["$KEY"]="Error: Content not found"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            service)
                SERVICE_NAME=$(echo "$criterion" | jq -r '.service')
                if systemctl is-active --quiet "$SERVICE_NAME"; then
                    DATA["$KEY"]="active"
                else
                    DATA["$KEY"]="Error: Service not active"
                fi
                ;;
            directory)
                DIR_PATH=$(echo "$criterion" | jq -r '.path')
                if [[ -d "$DIR_PATH" ]]; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Directory not found"
                fi
                ;;
            config_check)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                PARAMETER=$(echo "$criterion" | jq -r '.parameter')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')
                if [[ -f "$FILE_PATH" ]]; then
                    if [[ "$PARAMETER" == "owner" ]]; then
                        OWNER=$(stat -c "%U" "$FILE_PATH")
                        if [[ "$OWNER" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect owner"
                        fi
                    elif [[ "$PARAMETER" == "group" ]]; then
                        GROUP=$(stat -c "%G" "$FILE_PATH")
                        if [[ "$GROUP" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect group"
                        fi
                    elif [[ "$PARAMETER" == "permissions" ]]; then
                        PERM=$(stat -c "%A" "$FILE_PATH")
                        # Potong karakter pertama (misalnya '-') dari permission string
                        PERM=${PERM:1}
                        if [[ "$PERM" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect permissions"
                        fi
                    else
                        DATA["$KEY"]="Error: Invalid parameter"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            package)
                PACKAGE_NAME=$(echo "$criterion" | jq -r '.name')
                if dpkg -l | grep -q "^ii  $PACKAGE_NAME "; then
                    DATA["$KEY"]="installed"
                else
                    DATA["$KEY"]="Error: Package not installed"
                fi
                ;;
            user)
                USER_NAME="$KEY"
#                USER_NAME=$(echo "$criterion" | jq -r '.name')
                if id "$USER_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: User not found"
                fi
                #echo "[DEBUG] User $KEY value: ${DATA[$KEY]}"
                ;;
            group)
                GROUP_NAME=$(echo "$criterion" | jq -r '.name')
                if getent group "$GROUP_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Group not found"
                fi
                ;;
            *)
                echo "Unsupported criterion type: $TYPE"
                exit 1
                ;;
        esac
    done < <(echo "$SCHEME" | jq -c '.criteria[]')

    # Buat JSON untuk request grading
    CLIENT_DATA=$(jq -n \
        --arg lab_id "$LAB_ID" \
        --arg class_name "$CLASS_NAME" \
        --argjson data "$(for key in "${!DATA[@]}"; do echo "{\"$key\": \"${DATA[$key]}\"}"; done | jq -s 'add')" \
        '{"lab_id": $lab_id, "class_name": $class_name, "client_data": $data}')

    # Debugging: Tampilkan data yang akan dikirim
#    echo "Sending data to server: $CLIENT_DATA"

    # Kirim data ke server untuk grading
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$CLIENT_DATA" \
    "$SERVER_URL/grade-lab")

    # Tampilkan hasil grading dengan format yang lebih baik
    print_grading_result "$LAB_ID" "$RESPONSE"
}

function list_labs() {
    RESPONSE=$(curl -s -X GET "$SERVER_URL/list-labs")

    LABS=$(echo "$RESPONSE" | jq -r '.labs[] | "\(.lab_id): \(.scheme_path)"')
    if [[ -z "$LABS" ]]; then
        echo "No labs found"
    else
        echo "Available Labs:"
        echo "$LABS"
    fi
}

function print_grading_result() {
    LAB_ID=$1
    RESPONSE=$2

    LOG_TXT_FILE="/var/log/gradingctl/labs/${LAB_ID}.log"
    mkdir -p "/var/log/gradingctl/labs"
    echo -n "" > "$LOG_TXT_FILE"

    FEEDBACK=$(echo "$RESPONSE" | jq -c '.feedback // []')
    SCORE=$(echo "$RESPONSE" | jq -r '.score // 0')
    DURATION=$(echo "$RESPONSE" | jq -r '.duration // 0' | awk '{printf("%d\n", ($1+59)/60)}')
    LOG_PATH=$(echo "$RESPONSE" | jq -r '.log_path // ""')

    # Write failed case log
    i=1
    echo "$FEEDBACK" | jq -r '.[]' | while IFS= read -r feedback_msg; do
        NOW=$(date '+%Y-%m-%d %H:%M:%S')
        echo "[$NOW] CASE: ${feedback_msg%: Failed} | ERROR: Failed" >> "$LOG_TXT_FILE"
        ((i++))
    done

    echo -e "${NC}[-] Grading lab -> $LAB_ID${NC}"

    # Display result logic
    if [[ "$FEEDBACK" == "[]" && "$SCORE" -gt 0 ]]; then
        echo -e "${GREEN}    => All tasks completed successfully [✓]${NC}"
    else
        local i=1
        echo "$FEEDBACK" | jq -r '.[]' | while IFS= read -r feedback_msg; do
            echo -e "${RED}    => case $i - $feedback_msg [x]${NC}"
            ((i++))
        done
        echo -e "${RED}[x] Oh no! You didn't complete all the tasks yet${NC}"

        LOG_JSON_FILE="/var/log/gradingctl/labs/${LAB_ID}.log"
        echo -e "${YELLOW}[!] Hint: You may check gradingctl fetch-log $LAB_ID${NC}"
        echo -e "${YELLOW}[!] Or open the log file at: $LOG_JSON_FILE${NC}"
    fi

    echo -e "${NC}[-] Time -> $DURATION minutes"
    echo -e "${NC}[-] Score -> $SCORE${NC}"

    if [[ "$SCORE" == "100" ]]; then
        echo -e "${GREEN}[✓] Congratulations! You've completed the task!${NC}"
    else
        echo -e "${GREEN}[✓] Don't worry, we keep your higher score${NC}"
    fi
}

function finish() {
    TOKEN=$(cat ~/.nusactl_token)
    if [[ -z "$TOKEN" ]]; then
        echo -e "${RED}Error: Token not found. Please login first.${NC}"
        exit 1
    fi

    LAB_ID=$1
    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Error: Lab ID is required.${NC}"
        exit 1
    fi

    # Kirim request ke server untuk menghapus lab yang aktif
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/finish-lab")

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    else
        echo -e "${GREEN}$MESSAGE${NC}"
        # Hapus file lab aktif
        rm -f "$ACTIVE_LAB_FILE"
    fi
}

function logout() {
    if [[ -f ~/.nusactl_token ]]; then
        rm ~/.nusactl_token
        echo -e "${GREEN}Logged out successfully.${NC}"
    else
        echo -e "${YELLOW}No active session found.${NC}"
    fi
}

function fetch_log() {
    LAB_ID=$1
    LOG_FILE="/var/log/gradingctl/labs/${LAB_ID}.log"
    if [[ -f "$LOG_FILE" ]]; then
        cat "$LOG_FILE"
    else
        echo "Log file not found for lab: $LAB_ID"
    fi
}


#function fetch_log() {
#    TOKEN=$(cat ~/.nusactl_token)
#    LAB_ID=$1
#    SERVER_URL="10.10.10.12:5000"
#    RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$SERVER_URL/get-log?lab_id=$LAB_ID")
#    LOG_CONTENT=$(echo "$RESPONSE" | jq -r '.content // .error')
#    echo "$LOG_CONTENT"
#}

function help() {
    echo -e "${BLUE}Usage: gradingctl {command} [options]${NC}"
    echo -e "${BLUE}Commands:${NC}"
    echo -e "  ${GREEN}login${NC}       - Login to the system"
    echo -e "  ${GREEN}register${NC}    - Register a new user"
    echo -e "  ${GREEN}start${NC}       - Start a lab (usage: start <lab_id> [-s|-f])"
    echo -e "  ${GREEN}grade${NC}       - Grade a lab (usage: grade <lab_id>)"
    echo -e "  ${GREEN}finish${NC}      - Finish a lab (usage: finish <lab_id>)"
    echo -e "  ${GREEN}logout${NC}      - Logout from the system"
    echo -e "  ${GREEN}list-labs${NC}   - List all available labs"
    echo -e "  ${GREEN}-h, --help${NC}  - Show this help message"
    echo -e "${BLUE}Options:${NC}"
    echo -e "  ${YELLOW}-s${NC}         - Show simplified scheme when starting a lab"
    echo -e "  ${YELLOW}-f${NC}         - Save scheme to file when starting a lab"
}

case $1 in
    login) login ;;
    register) register ;;
    start) start_lab $2 $3 ;;  # Tambahkan $3 untuk opsi (-s atau -f)
    grade) grade_lab $2 ;;
    finish) finish $2 ;;
    logout) logout ;;
    fetch-log) fetch_log $2 ;;
    list-labs) list_labs ;;
    -h|--help) help ;;
    *) echo "Usage: gradingctl {login|register|start|grade|finish|logout|fetch-log|list-labs|-h|--help}" ;;
esac
