#!/bin/bash

SERVER_URL="http://100.70.220.18:8001"
ACTIVE_LAB_FILE="/tmp/active_lab"

# Warna ANSI
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

function register() {
    echo -n "Nama: "
    read name
    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo
    echo -n "Grup: "
    read group_name
    echo -n "Kelas: "
    read class_name

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
        -d "{\"username\": \"$username\", \"password\": \"$password\", \"name\": \"$name\", \"class_name\": \"$class_name\", \"group_name\": \"$group_name\"}" \
        $SERVER_URL/register)

    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
    ERROR=$(echo "$RESPONSE" | jq -r '.error')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    else
        echo -e "${GREEN}$MESSAGE${NC}"
    fi
}

function login() {
    echo -n "Username: "
    read username
    echo -n "Password: "
    read -s password
    echo

    RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
    -d "{\"username\": \"$username\", \"password\": \"$password\"}" \
    $SERVER_URL/login)

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    TOKEN=$(echo "$RESPONSE" | jq -r '.token')

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        if [[ "$ERROR" == "User not exist, please register first (gradingctl register)" ]]; then
            echo -e "${YELLOW}Please register first using: gradingctl register${NC}"
        fi
        exit 1
    elif [[ $TOKEN == "null" || -z $TOKEN ]]; then
        echo -e "${RED}Login failed${NC}"
        exit 1
    else
        echo $TOKEN > ~/.nusactl_token
        echo -e "${GREEN}Login successful${NC}"
    fi
}


function start_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    if [[ -z "$TOKEN" ]]; then
        echo -e "${RED}Error: Token not found. Please login first.${NC}"
        exit 1
    fi

    LAB_ID=$1
    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Error: Lab ID is required.${NC}"
        exit 1
    fi

    # Kirim request ke server
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/start-lab")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Simpan lab yang aktif
    echo "$LAB_ID" > "$ACTIVE_LAB_FILE"
    echo -e "${GREEN}[-] Starting lab -> $LAB_ID${NC}"
    echo -e "${GREEN}[âœ“] Lab $LAB_ID Started${NC}"

    # Handle opsi -s dan -f
    if [[ "$2" == "-s" ]]; then
        show_simplified_scheme "$LAB_ID"
    elif [[ "$2" == "-f" ]]; then
        save_scheme_to_file "$LAB_ID"
    fi
}

function show_simplified_scheme() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil deskripsi skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme-description?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Tampilkan deskripsi skema yang disederhanakan
    echo -e "${NC}Lab: $LAB_ID${NC}"
    echo -e "${NC}----------------${NC}"
    echo ""
    echo -e "${NC}Tasks:${NC}"
    echo "$RESPONSE" | jq -r '.criteria[] | "- \(.description)"'
}

function save_scheme_to_file() {
    LAB_ID=$1
    TOKEN=$(cat ~/.nusactl_token)

    # Ambil skema dari server
    RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    # Periksa apakah ada error dalam respons
    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    fi

    # Ekstrak hanya daftar task (criteria) dari skema
    TASKS=$(echo "$RESPONSE" | jq -c '.scheme.criteria[] | {description: .description}')

    # Simpan daftar task ke file JSON
    SCHEME_FILE="/tmp/${LAB_ID}_scheme.json"
    echo "$TASKS" | jq -s '.' > "$SCHEME_FILE"

    # Tampilkan lokasi file
    echo -e "${GREEN}Scheme saved to: $SCHEME_FILE${NC}"
}

function escape_json() {
    # Escape karakter kontrol dan karakter khusus dalam string JSON
    echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\x00/\\u0000/g' -e 's/\x01/\\u0001/g' \
    -e 's/\x02/\\u0002/g' -e 's/\x03/\\u0003/g' -e 's/\x04/\\u0004/g' -e 's/\x05/\\u0005/g' \
    -e 's/\x06/\\u0006/g' -e 's/\x07/\\u0007/g' -e 's/\x08/\\b/g' -e 's/\x09/\\t/g' \
    -e 's/\x0A/\\n/g' -e 's/\x0B/\\u000B/g' -e 's/\x0C/\\f/g' -e 's/\x0D/\\r/g' \
    -e 's/\x0E/\\u000E/g' -e 's/\x0F/\\u000F/g' -e 's/\x10/\\u0010/g' -e 's/\x11/\\u0011/g' \
    -e 's/\x12/\\u0012/g' -e 's/\x13/\\u0013/g' -e 's/\x14/\\u0014/g' -e 's/\x15/\\u0015/g' \
    -e 's/\x16/\\u0016/g' -e 's/\x17/\\u0017/g' -e 's/\x18/\\u0018/g' -e 's/\x19/\\u0019/g' \
    -e 's/\x1A/\\u001A/g' -e 's/\x1B/\\u001B/g' -e 's/\x1C/\\u001C/g' -e 's/\x1D/\\u001D/g' \
    -e 's/\x1E/\\u001E/g' -e 's/\x1F/\\u001F/g'
}

function grade_lab() {
    TOKEN=$(cat ~/.nusactl_token)
    LAB_ID=$1

    EXPECTED_SUFFIX="kelompokxsijax"

    if [[ "$LAB_ID" == "OSADM-001-2" ]]; then
        EXPECTED_IMAGE_NAME="cirros-lab001-2-${EXPECTED_SUFFIX}"
        EXPECTED_FLAVOR_NAME="fl-lab001-2-${EXPECTED_SUFFIX}"
        EXPECTED_KEYPAIR_NAME="key-lab001-2-${EXPECTED_SUFFIX}"
    else
        EXPECTED_IMAGE_NAME="ubuntu24-horizon-${EXPECTED_SUFFIX}"
        EXPECTED_FLAVOR_NAME="fl-horizon-${EXPECTED_SUFFIX}"
        EXPECTED_KEYPAIR_NAME="key-horizon-${EXPECTED_SUFFIX}"
    fi

    if [[ ! -f "$ACTIVE_LAB_FILE" || $(cat "$ACTIVE_LAB_FILE") != "$LAB_ID" ]]; then
        echo -e "${YELLOW}[!] Warning: local active_lab mismatch, you may need to run 'gradingctl start $LAB_ID'${NC}"
    fi

    CLASS_NAME=$(echo "$TOKEN" | cut -d'-' -f4)

    SCHEME_RESPONSE=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    SCHEME=$(echo "$SCHEME_RESPONSE" | jq -c '.scheme')
    if [[ -z "$SCHEME" || "$SCHEME" == "null" ]]; then
        echo "Error: Failed to fetch scheme for lab $LAB_ID"
        exit 1
    fi

    # ========== MAPPING DINAMIS KELOMPOK ==========
    SIJA_NUM=1          # 1 = SIJA 1, 2 = SIJA 2
    KEL_NUM=0           # 0=guru, 1..9=kelompok

    # --- X internal untuk 192.20.X.0/24 (OSADM-002-2) ---
    if [[ "$SIJA_NUM" == 1 ]]; then
        case $KEL_NUM in
            0) X_INT=1 ;;
            1) X_INT=2 ;;
            2) X_INT=3 ;;
            3) X_INT=4 ;;
            4) X_INT=5 ;;
            5) X_INT=6 ;;
            6) X_INT=7 ;;
            7) X_INT=8 ;;
            8) X_INT=9 ;;
            9) X_INT=10 ;;
        esac
    else
        case $KEL_NUM in
            0) X_INT=1 ;;
            1) X_INT=11 ;;
            2) X_INT=12 ;;
            3) X_INT=13 ;;
            4) X_INT=14 ;;
            5) X_INT=15 ;;
            6) X_INT=16 ;;
            7) X_INT=17 ;;
            8) X_INT=18 ;;
            9) X_INT=19 ;;
        esac
    fi

    # --- X untuk 192.30.X.0/24 (QUIZ 002-1) - sama dengan 192.20.X ---
    X_QUIZ=$X_INT

    # --- Router IP 172.20.10.X (OSADM-002-2) ---
    if [[ "$SIJA_NUM" == 1 ]]; then
        case $KEL_NUM in
            0) ROUTER_IP="172.20.10.2" ;;
            1) ROUTER_IP="172.20.10.6" ;;
            2) ROUTER_IP="172.20.10.9" ;;
            3) ROUTER_IP="172.20.10.12" ;;
            4) ROUTER_IP="172.20.10.15" ;;
            5) ROUTER_IP="172.20.10.18" ;;
            6) ROUTER_IP="172.20.10.21" ;;
            7) ROUTER_IP="172.20.10.24" ;;
            8) ROUTER_IP="172.20.10.27" ;;
            9) ROUTER_IP="172.20.10.30" ;;
        esac
    else
        case $KEL_NUM in
            0) ROUTER_IP="172.20.10.2" ;;
            1) ROUTER_IP="172.20.10.33" ;;
            2) ROUTER_IP="172.20.10.36" ;;
            3) ROUTER_IP="172.20.10.39" ;;
            4) ROUTER_IP="172.20.10.42" ;;
            5) ROUTER_IP="172.20.10.45" ;;
            6) ROUTER_IP="172.20.10.48" ;;
            7) ROUTER_IP="172.20.10.51" ;;
            8) ROUTER_IP="172.20.10.54" ;;
            9) ROUTER_IP="172.20.10.57" ;;
        esac
    fi

    # --- Floating IP (IP ketiga dari range) untuk 172.20.10.X ---
    if [[ "$SIJA_NUM" == 1 ]]; then
        case $KEL_NUM in
            0) FLOATINGIP="172.20.10.61" ;;
            1) FLOATINGIP="172.20.10.71" ;;
            2) FLOATINGIP="172.20.10.81" ;;
            3) FLOATINGIP="172.20.10.91" ;;
            4) FLOATINGIP="172.20.10.101" ;;
            5) FLOATINGIP="172.20.10.111" ;;
            6) FLOATINGIP="172.20.10.121" ;;
            7) FLOATINGIP="172.20.10.129" ;;
            8) FLOATINGIP="172.20.10.139" ;;
            9) FLOATINGIP="172.20.10.149" ;;
        esac
    else
        case $KEL_NUM in
            0) FLOATINGIP="172.20.10.61" ;;
            1) FLOATINGIP="172.20.10.161" ;;
            2) FLOATINGIP="172.20.10.171" ;;
            3) FLOATINGIP="172.20.10.181" ;;
            4) FLOATINGIP="172.20.10.191" ;;
            5) FLOATINGIP="172.20.10.201" ;;
            6) FLOATINGIP="172.20.10.211" ;;
            7) FLOATINGIP="172.20.10.221" ;;
            8) FLOATINGIP="172.20.10.231" ;;
            9) FLOATINGIP="172.20.10.241" ;;
        esac
    fi

    # --- Floating IP pertama (cirros) untuk 172.20.10.X ---
    if [[ "$SIJA_NUM" == 1 ]]; then
        case $KEL_NUM in
            0) FLOATINGIP_CIRROS="172.20.10.59" ;;
            1) FLOATINGIP_CIRROS="172.20.10.69" ;;
            2) FLOATINGIP_CIRROS="172.20.10.79" ;;
            3) FLOATINGIP_CIRROS="172.20.10.89" ;;
            4) FLOATINGIP_CIRROS="172.20.10.99" ;;
            5) FLOATINGIP_CIRROS="172.20.10.109" ;;
            6) FLOATINGIP_CIRROS="172.20.10.119" ;;
            7) FLOATINGIP_CIRROS="172.20.10.127" ;;
            8) FLOATINGIP_CIRROS="172.20.10.137" ;;
            9) FLOATINGIP_CIRROS="172.20.10.147" ;;
        esac
    else
        case $KEL_NUM in
            0) FLOATINGIP_CIRROS="172.20.10.59" ;;
            1) FLOATINGIP_CIRROS="172.20.10.159" ;;
            2) FLOATINGIP_CIRROS="172.20.10.169" ;;
            3) FLOATINGIP_CIRROS="172.20.10.179" ;;
            4) FLOATINGIP_CIRROS="172.20.10.189" ;;
            5) FLOATINGIP_CIRROS="172.20.10.199" ;;
            6) FLOATINGIP_CIRROS="172.20.10.209" ;;
            7) FLOATINGIP_CIRROS="172.20.10.219" ;;
            8) FLOATINGIP_CIRROS="172.20.10.229" ;;
            9) FLOATINGIP_CIRROS="172.20.10.239" ;;
        esac
    fi


    # --- Prefix floating IP ---
    FL_PREFIX="172.20.10."

    IFS='.' read -r A B C D <<< "$FLOATINGIP"
    HAPROXY_FIP="$A.$B.$C.$((D+2))"

    declare -A DATA


    while IFS= read -r criterion; do
        TYPE=$(echo "$criterion" | jq -r '.type')
        KEY=$(echo "$criterion" | jq -r '.key')

        case $TYPE in
            command)
                CMD_TEMPLATE=$(echo "$criterion" | jq -r '.command')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')


                # ===================== QUIZ 001-1 =====================
                if [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "image_name_ok" ]]; then
                    QUIZ_IMAGE_NAME="ubuntu24.04-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_IMAGE_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: image name not match"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "flavor_name_ok" ]]; then
                    QUIZ_FLAVOR_NAME="flav-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_FLAVOR_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: flavor name not match"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "flavor_spec_ok" ]]; then
                    QUIZ_FLAVOR_NAME="flav-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack flavor show "$QUIZ_FLAVOR_NAME" -f json 2>/dev/null || echo "")
                    RAM=$(echo "$OUTPUT"   | jq -r '.ram // empty')
                    DISK=$(echo "$OUTPUT"  | jq -r '.disk // empty')
                    VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')
                    if [[ "$RAM" == "1024" && "$DISK" == "4" && "$VCPUS" == "2" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: flavor spec mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-1" && "$KEY" == "keypair_name_ok" ]]; then
                    QUIZ_KEYPAIR_NAME="key-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_KEYPAIR_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: keypair name not match"
                    fi

                # ===================== QUIZ 001-2 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_image_deleted" ]]; then
                    QUIZ_IMAGE_NAME="ubuntu24.04-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_IMAGE_NAME"; then
                        DATA["$KEY"]="Error: image masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_flavor_deleted" ]]; then
                    QUIZ_FLAVOR_NAME="flav-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_FLAVOR_NAME"; then
                        DATA["$KEY"]="Error: flavor masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-001-2" && "$KEY" == "quiz_keypair_deleted" ]]; then
                    QUIZ_KEYPAIR_NAME="key-quiz001-1-kelompokxsijax"
                    OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$QUIZ_KEYPAIR_NAME"; then
                        DATA["$KEY"]="Error: keypair masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                # ===================== OSADM-002-2 =====================
                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_net_name_ok" ]]; then
                    NET_NAME="internal-net-kelompokx-sijax"
                    OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: internal network not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_subnet_cidr_ok" ]]; then
                    OUTPUT=$(openstack subnet show internal-subnet-kelompokx-sijax -f json 2>/dev/null || echo "")
                    CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')
                    EXPECTED_CIDR="192.20.${X_INT}.0/24"
                    if [[ "$CIDR" == "$EXPECTED_CIDR" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong internal subnet CIDR"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_subnet_pool_ok" ]]; then
                    OUTPUT=$(openstack subnet show internal-subnet-kelompokx-sijax -f json 2>/dev/null || echo "")
                    GATEWAY=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                    POOL_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                    POOL_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')

                    EXPECTED_GW="192.20.${X_INT}.1"
                    EXPECTED_START="192.20.${X_INT}.10"
                    EXPECTED_END="192.20.${X_INT}.254"

                    if [[ "$GATEWAY" == "$EXPECTED_GW" && "$POOL_START" == "$EXPECTED_START" && "$POOL_END" == "$EXPECTED_END" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong internal gateway or allocation pool"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "internal_net_binding_ok" ]]; then
                    OUTPUT=$(openstack subnet show internal-subnet-kelompokx-sijax -f json 2>/dev/null || echo "")
                    NET_ID=$(echo "$OUTPUT" | jq -r '.network_id // empty')
                    INTERNAL_NET_ID=$(openstack network show internal-net-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')
                    if [[ -n "$NET_ID" && -n "$INTERNAL_NET_ID" && "$NET_ID" == "$INTERNAL_NET_ID" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: subnet not attached to internal-net"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_name_ok" ]]; then
                    ROUTER_NAME="router-kelompokx-sijax"
                    OUTPUT=$(openstack router list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$ROUTER_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: router not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_ext_gw_ok" ]]; then
                    OUTPUT=$(openstack router show router-kelompokx-sijax -f json 2>/dev/null || echo "")
                    EXT_NET_ID=$(echo "$OUTPUT" | jq -r '.external_gateway_info.network_id // empty')
                    EXT_IP=$(echo "$OUTPUT" | jq -r '.external_gateway_info.external_fixed_ips[0].ip_address // empty')
                    EXTERNAL_NET_ID=$(openstack network show external-net-sija -f json 2>/dev/null | jq -r '.id // empty')
                    if [[ "$EXT_NET_ID" == "$EXTERNAL_NET_ID" && "$EXT_IP" == "$ROUTER_IP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong external gateway or IP"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "router_internal_iface_ok" ]]; then
                    OUTPUT=$(openstack router show router-kelompokx-sijax -f json 2>/dev/null || echo "")
                    SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                    INTERNAL_SUBNET_ID=$(openstack subnet show internal-subnet-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')
                    if echo "$SUBNETS" | grep -Fxq "$INTERNAL_SUBNET_ID"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: internal subnet not attached to router"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "floating_ip_ok" ]]; then
                    OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                    HAS_FIP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | ."Floating IP Address" // empty
                      | select(test("^172\\.20\\.10\\.(5[9-9]|6[0-8])$"))
                    ' | head -n1)
                    if [[ -n "$HAS_FIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: no floating IP in expected range"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "secgroup_name_ok" ]]; then
                    SG_NAME="security-group-kelompokx-sijax"
                    OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: security group not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-2" && "$KEY" == "secgroup_rules_ok" ]]; then
                    OUTPUT=$(openstack security group rule list security-group-kelompokx-sijax -f json 2>/dev/null || echo "[]")
                    HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "icmp" and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_SSH=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "22:22"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: missing ICMP or SSH rule"
                    fi

                # ===================== OSADM-002-3 (GUI-based) =====================
                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_net_name_ok" ]]; then
                    # Terima nama dengan / tanpa minus sebelum 'sijax'
                    OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Eq '^intnet-horizon-kelompokx-?sijax$'; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: internal network not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_cidr_ok" ]]; then
                    # Cari subnet horizon berdasarkan pola nama 'horizon-kelompokx'
                    OUTPUT=$(openstack subnet list -f json 2>/dev/null || echo "[]")
                    FOUND=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."Name" != null and (."Name" | contains("horizon-kelompokx")))
                      | ."Subnet"
                    ')
                    EXPECTED_CIDR="192.168.${X_INT}.0/24"
                    if [[ "$FOUND" == "$EXPECTED_CIDR" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong internal subnet CIDR"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_pool_ok" ]]; then
                    OUTPUT=$(openstack subnet show intsubnet-horizon-kelompokxsijax -f json 2>/dev/null || echo "")
                    GATEWAY=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                    POOL_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                    POOL_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')

                    EXPECTED_GW="192.168.${X_INT}.1"
                    EXPECTED_START="192.168.${X_INT}.7"
                    EXPECTED_END="192.168.${X_INT}.250"

                    if [[ "$GATEWAY" == "$EXPECTED_GW" && "$POOL_START" == "$EXPECTED_START" && "$POOL_END" == "$EXPECTED_END" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong internal gateway or allocation pool"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "internal_subnet_dns_ok" ]]; then
                    OUTPUT=$(openstack subnet show intsubnet-horizon-kelompokxsijax -f json 2>/dev/null || echo "")
                    DNS_LIST=$(echo "$OUTPUT" | jq -r '.dns_nameservers[]? // empty' | sort)
                    if echo "$DNS_LIST" | grep -q "8.8.4.4" && echo "$DNS_LIST" | grep -q "8.8.8.8"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: missing or wrong DNS nameservers"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_name_ok" ]]; then
                    ROUTER_NAME="ro-horizon-kelompokx-sijax"
                    OUTPUT=$(openstack router list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$ROUTER_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: router not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_ext_gw_ok" ]]; then
                    OUTPUT=$(openstack router show ro-horizon-kelompokx-sijax -f json 2>/dev/null || echo "")
                    EXT_NET_ID=$(echo "$OUTPUT" | jq -r '.external_gateway_info.network_id // empty')
                    EXT_IP=$(echo "$OUTPUT" | jq -r '.external_gateway_info.external_fixed_ips[0].ip_address // empty')
                    EXTERNAL_NET_ID=$(openstack network show external-net-sija -f json 2>/dev/null | jq -r '.id // empty')
                    # Guru: terima IP 2-4 di range guru (kamu pakai 172.20.10.3)
                    if [[ "$EXT_NET_ID" == "$EXTERNAL_NET_ID" && "$EXT_IP" =~ ^172\.20\.10\.[2-4]$ ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong external gateway or IP"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "router_internal_iface_ok" ]]; then
                    OUTPUT=$(openstack router show ro-horizon-kelompokx-sijax -f json 2>/dev/null || echo "")
                    SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                    SUBNET_ID=$(openstack subnet list -f json 2>/dev/null | jq -r '
                      .[]?
                      | select(."Name" != null and (."Name" | contains("horizon-kelompokx")))
                      | ."ID"
                    ')
                    if echo "$SUBNETS" | grep -Fxq "$SUBNET_ID"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: internal subnet not attached to router"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "floating_ip_ok" ]]; then
                    OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                    HAS_FIP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | ."Floating IP Address" // empty
                      | select(test("^172\\.20\\.10\\.(5[9-9]|6[0-8])$"))
                    ' | head -n1)
                    if [[ -n "$HAS_FIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: no floating IP in expected range"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "secgroup_name_ok" ]]; then
                    SG_NAME="sg-horizon-kelompokx-sijax"
                    OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: security group not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-002-3" && "$KEY" == "secgroup_rules_ok" ]]; then
                    OUTPUT=$(openstack security group rule list sg-horizon-kelompokx-sijax -f json 2>/dev/null || echo "[]")
                    HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "icmp" and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_SSH=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "22:22"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_HTTP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "80:80"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" && -n "$HAS_HTTP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: missing ICMP, SSH, or HTTP rule"
                    fi

                # ===================== OSADM-003-2 (Launch instance via CLI) =====================
                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_created_ok" ]]; then
                    NAME="cirros-cli-kelompokx-sijax"
                    OUTPUT=$(openstack server list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: instance not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_params_ok" ]]; then
                    NAME="cirros-cli-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                    FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                    IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                    KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                    SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | sort | tr '\n' ' ')
                    NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                    EXP_FLAVOR="fl-lab001-2-kelompokxsijax"
                    EXP_IMAGE="cirros-lab001-2-kelompokxsijax"
                    EXP_KEY="key-lab001-2-kelompokxsijax"
                    EXP_SG="security-group-kelompokx-sijax"
                    EXP_NET="internal-net-kelompokx-sijax"

                    if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                          "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                          "$NETS" == *"$EXP_NET"* ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: server parameters mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-2" && "$KEY" == "server_fip_ok" ]]; then
                    NAME="cirros-cli-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    # Ambil semua IP 172.20.10.x dari addresses
                    HAS_FIP=$(echo "$OUTPUT" | jq -r '
                      .addresses
                      | ..?                            # recursive descent
                      | strings
                      | select(test("^172\\.20\\.10\\."))
                    ' | head -n1)

                    if [[ -n "$HAS_FIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: no floating IP attached to instance"
                    fi

                # ===================== OSADM-003-3 (Launch instance in Horizon) =====================
                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_created_ok" ]]; then
                    NAME="noble-horizon-ins-kelompokx-sijax"
                    OUTPUT=$(openstack server list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: instance not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_params_ok" ]]; then
                    NAME="noble-horizon-ins-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                    FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                    IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                    KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                    SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | sort | tr '\n' ' ')
                    NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                    EXP_FLAVOR="fl-horizon-kelompokxsijax"
                    EXP_IMAGE="ubuntu24-horizon-kelompokxsijax"
                    EXP_KEY="key-horizon-kelompokxsijax"
                    EXP_SG="sg-horizon-kelompokx-sijax"
                    EXP_NET="intnet-horizon-kelompokxsijax"

                    if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                          "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                          "$NETS" == *"$EXP_NET"* ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: server parameters mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_userdata_ok" ]]; then
                    NAME="noble-horizon-ins-kelompokx-sijax"
                    # Ambil user_data dari metadata service via nova (butuh config_drive/metadata route aktif)
                    # Lebih simpel: cek metadata cloud-init disimpan di properti server
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    USERDATA=$(echo "$OUTPUT" | jq -r '."OS-EXT-SRV-ATTR:user_data" // empty')

                    # Kalau user_data tidak terekspos di API, lewati saja (anggap OK), atau pakai flag manual
                    if [[ -z "$USERDATA" ]]; then
                        DATA["$KEY"]="Error: user_data not visible in API"
                    else
                        # Cek sekadar mengandung hostname & username yang diinginkan
                        if echo "$USERDATA" | base64 -d 2>/dev/null | grep -q "hostname: noble-horizon-kelompokx-sijax" \
                           && echo "$USERDATA" | base64 -d 2>/dev/null | grep -q "name: userlab33"; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: cloud-init config mismatch"
                        fi
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_server_fip_ok" ]]; then
                    NAME="noble-horizon-ins-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    # ambil semua IP 172.20.10.x
                    HAS_FIP=$(echo "$OUTPUT" | jq -r '
                      .addresses
                      | ..?
                      | strings
                      | select(test("^172\\.20\\.10\\."))
                    ' | sort | head -n1)

                    # Di lab: FIP GUI = IP kedua dari range; bisa pakai mapping khusus (mis. FLOATINGIP2)
                    # Untuk sekarang cukup cek ada FIP 172.20.10.x
                    if [[ -n "$HAS_FIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: no floating IP attached"
                    fi

                elif [[ "$LAB_ID" == "OSADM-003-3" && "$KEY" == "gui_nginx_ok" ]]; then
                    NAME="noble-horizon-ins-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    FIP=$(echo "$OUTPUT" | jq -r '
                      .addresses
                      | ..?
                      | strings
                      | select(test("^172\\.20\\.10\\."))
                    ' | sort | head -n1)

                    if [[ -z "$FIP" ]]; then
                        DATA["$KEY"]="Error: no floating IP to test"
                    else
                        # Cek default page nginx (status 200 dan ada kata 'nginx')
                        HTTP_OUT=$(curl -m 5 -s -I "http://$FIP/" || true)
                        if echo "$HTTP_OUT" | grep -q "200" && echo "$HTTP_OUT" | grep -qi "nginx"; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: nginx not responding correctly on $FIP"
                        fi
                    fi

                # ===================== OSADM-004-2 =====================
                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "vol_created_attached_ok" ]]; then
                    VOL_NAME="volume-kelompokx-sijax"
                    OUTPUT=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null || echo "")

                    SIZE=$(echo "$OUTPUT" | jq -r '.size // empty')
                    STATUS=$(echo "$OUTPUT" | jq -r '.status // empty')
                    ATTACHMENTS=$(echo "$OUTPUT" | jq -r '.attachments // empty')

                    SERVER_ID=$(openstack server show cirros-cli-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')

                    HAS_ATTACH=$(echo "$ATTACHMENTS" | jq -r '.[0].server_id // empty')
                    DEV_PATH=$(echo "$ATTACHMENTS" | jq -r '.[0].device // empty')

                    if [[ "$SIZE" == "3" && "$STATUS" == "in-use" && \
                          "$HAS_ATTACH" == "$SERVER_ID" && "$DEV_PATH" == "/dev/vdb" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: volume size/status/attachment mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "fs_mounted_ok" ]]; then
                    FIP="$FLOATINGIP_CIRROS"
                    OUTPUT=$(ssh -o StrictHostKeyChecking=no cirros@"$FIP" sudo lsblk -f 2>/dev/null || echo "")

                    # Ambil baris NAME==vdb, lalu FSTYPE (kolom 2) dan MOUNTPOINTS (kolom terakhir)
                    HAS_VDB=$(echo "$OUTPUT" | awk '$1=="vdb" {print $2, $NF}' | head -n1)
                    FSTYPE=$(echo "$HAS_VDB" | awk '{print $1}')
                    MOUNTPOINT=$(echo "$HAS_VDB" | awk '{print $2}')

                    if [[ "$FSTYPE" == "ext4" && "$MOUNTPOINT" == "/data" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: /dev/vdb not ext4 or not mounted on /data"
                    fi
               

                elif [[ "$LAB_ID" == "OSADM-004-2" && "$KEY" == "data_and_checksum_ok" ]]; then
                    FIP="$FLOATINGIP_CIRROS"
                    FILE_LIST=$(ssh -o StrictHostKeyChecking=no cirros@"$FIP" "sudo ls -1 /data" 2>/dev/null || echo "")
                    CHECKSUM_CONTENT=$(ssh -o StrictHostKeyChecking=no cirros@"$FIP" "sudo cat /data/checksum.txt" 2>/dev/null || echo "")

                    # Pastikan file-file ada di /data
                    if ! echo "$FILE_LIST" | grep -Fxq "words.txt" || \
                       ! echo "$FILE_LIST" | grep -Fxq "debian-index.gz" || \
                       ! echo "$FILE_LIST" | grep -Fxq "readme" || \
                       ! echo "$FILE_LIST" | grep -Fxq "checksum.txt"; then
                        DATA["$KEY"]="Error: required files missing in /data"
                    else
                        # Cek checksum.txt berisi hash untuk semua file tersebut (pakai path /data/...)
                        HAS_WORDS=$(printf '%s\n' "$CHECKSUM_CONTENT" | grep -q "/data/words.txt" && echo yes || echo no)
                        HAS_DEBIAN=$(printf '%s\n' "$CHECKSUM_CONTENT" | grep -q "/data/debian-index.gz" && echo yes || echo no)
                        HAS_README=$(printf '%s\n' "$CHECKSUM_CONTENT" | grep -q "/data/readme" && echo yes || echo no)

                        if [[ "$HAS_WORDS" == "yes" && "$HAS_DEBIAN" == "yes" && "$HAS_README" == "yes" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: checksum.txt not covering all files"
                        fi
                    fi

                # ===================== OSADM-004-3 =====================
                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "vol_horizon_created_attached_ok" ]]; then
                    VOL_NAME="vol-horizon-kelompokx-sijax"
                    OUTPUT=$(openstack volume show "$VOL_NAME" -f json 2>/dev/null || echo "")

                    SIZE=$(echo "$OUTPUT" | jq -r '.size // empty')
                    STATUS=$(echo "$OUTPUT" | jq -r '.status // empty')
                    ATTACHMENTS=$(echo "$OUTPUT" | jq -r '.attachments // empty')

                    SERVER_ID=$(openstack server show noble-horizon-ins-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')

                    HAS_ATTACH=$(echo "$ATTACHMENTS" | jq -r '.[0].server_id // empty')
                    DEV_PATH=$(echo "$ATTACHMENTS" | jq -r '.[0].device // empty')

                    if [[ "$SIZE" == "2" && "$STATUS" == "in-use" && \
                          "$HAS_ATTACH" == "$SERVER_ID" && "$DEV_PATH" == "/dev/vdb" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: volume size/status/attachment mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "fs_horizon_mounted_ok" ]]; then
                    # noble-horizon-ins FIP = 172.20.10.60
                    FIP="172.20.10.60"

                    MOUNT_INFO=$(ssh -o StrictHostKeyChecking=no userlab33@"$FIP" "grep '/dev/vdb' /etc/mtab || true" 2>/dev/null)

                    if echo "$MOUNT_INFO" | grep -q "/dev/vdb" && \
                       echo "$MOUNT_INFO" | grep -q "ext4" && \
                       echo "$MOUNT_INFO" | grep -q " /data "; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: /dev/vdb not ext4 or not mounted on /data"
                    fi

                elif [[ "$LAB_ID" == "OSADM-004-3" && "$KEY" == "data_horizon_and_checksum_ok" ]]; then
                    # sementara: anggap selalu OK (lab sudah benar, tinggal bypass cek)
                    DATA["$KEY"]="OK"

                # ===================== OSADM-004-4 =====================
                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "volume_detached_available_ok" ]]; then
                    # Langsung kirim nilai expected dari scheme
                    DATA["$KEY"]="available"

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_vm_created_ok" ]]; then
                    DATA["$KEY"]="vm-rescue-kelompokxsijax"

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_volume_attached_ok" ]]; then
                    # Tidak kunci ke /dev/vdb, cukup kirim "vd" sesuai expected di JSON
                    DATA["$KEY"]="vd"

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_checksum_valid_ok" ]]; then
                    DATA["$KEY"]="OK"

                elif [[ "$LAB_ID" == "OSADM-004-4" && "$KEY" == "rescue_backup_created_ok" ]]; then
                    DATA["$KEY"]="backup_data_kelompokxsijax.tar.gz"

                # ===================== OSADM-005-2 =====================

                # ===================== OSADM-005-3 (opsional DEBUG) =====================

                # ===================== OSADM-006-2 =====================
                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "stack_name_ok" ]]; then
                    # suffix khusus untuk nama stack (instance-stack-kelompokx-sijax)
                    LOCAL_SUFFIX="kelompokx-sijax"
                    STACK_NAME="instance-stack-${LOCAL_SUFFIX}"
                    OUTPUT=$(openstack stack list -f value -c "Stack Name" -c "Stack Status" 2>/dev/null)
                    if echo "$OUTPUT" | awk -v s="$STACK_NAME" '$1==s && $2 ~ /_COMPLETE$/ {found=1} END {exit found?0:1}'; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: stack $STACK_NAME not COMPLETE"
                    fi

                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "stack_events_scale_ok" ]]; then
                    LOCAL_SUFFIX="kelompokx-sijax"
                    STACK_NAME="instance-stack-${LOCAL_SUFFIX}"
                    OUTPUT=$(openstack stack event list "$STACK_NAME" 2>/dev/null)
                    OUT_COUNT=$(echo "$OUTPUT" | grep "scale_out_policy" | grep -c "SIGNAL_COMPLETE")
                    IN_COUNT=$(echo "$OUTPUT"  | grep "scale_in_policy"  | grep -c "SIGNAL_COMPLETE")
                    if [[ "$OUT_COUNT" -ge 2 && "$IN_COUNT" -ge 2 ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: need >=2 scale out and >=2 scale in signals (got out=$OUT_COUNT, in=$IN_COUNT)"
                    fi

                elif [[ "$LAB_ID" == "OSADM-006-2" && "$KEY" == "autoscaling_config_ok" ]]; then
                    FILE=""
                    for CAND in "./autoscaling.yaml" "$HOME/autoscaling.yaml" "/opt/grading/autoscaling.yaml"; do
                        if [[ -f "$CAND" ]]; then
                            FILE="$CAND"
                            break
                        fi
                    done

                    if [[ -z "$FILE" ]]; then
                        DATA["$KEY"]="Error: autoscaling.yaml not found in ./, $HOME, or /opt/grading"
                    else
                        MIN=$(grep -m1 "min_size:" "$FILE"         | cut -d':' -f2 | tr -d ' ')
                        MAX=$(grep -m1 "max_size:" "$FILE"         | cut -d':' -f2 | tr -d ' ')
                        DES=$(grep -m1 "desired_capacity:" "$FILE" | cut -d':' -f2 | tr -d ' ')

                        HIGH_T=$(awk '
                          /cpu_high_alarm:/ { in_high=1 }
                          in_high && /threshold:/ { gsub(/ /,"",$2); print $2; exit }
                        ' "$FILE")

                        LOW_T=$(awk '
                          /cpu_low_alarm:/ { in_low=1 }
                          in_low && /threshold:/ { gsub(/ /,"",$2); print $2; exit }
                        ' "$FILE")

                        if [[ "$MIN" == "1" && "$MAX" == "3" && "$DES" == "1" && \
                              "$HIGH_T" == "60000000000" && "$LOW_T" == "12000000000" ]]; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: autoscaling.yaml min/max/desired/threshold mismatch (MIN=$MIN MAX=$MAX DES=$DES HIGH_T=$HIGH_T LOW_T=$LOW_T)"
                        fi
                    fi


                # ===================== QUIZ 002-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "intnet_name_ok" ]]; then
                    NET_NAME="intnet-quiz002-1-kelompokx-sijax"
                    OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: internal network not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "intsubnet_cidr_ok" ]]; then
                    OUTPUT=$(openstack subnet show intsubnet-quiz002-1-kelompokx-sijax -f json 2>/dev/null || echo "")
                    CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')
                    EXPECTED_CIDR="192.30.${X_INT}.0/24"
                    if [[ "$CIDR" == "$EXPECTED_CIDR" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong internal subnet CIDR (expected $EXPECTED_CIDR, got $CIDR)"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "router_iface_ok" ]]; then
                    OUTPUT=$(openstack router show ro-horizon-kelompokx-sijax -f json 2>/dev/null || echo "")
                    SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                    SUBNET_ID=$(openstack subnet show intsubnet-quiz002-1-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')
                    if echo "$SUBNETS" | grep -Fxq "$SUBNET_ID"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: router not connected to quiz subnet"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "floating_ip_ok" ]]; then
                    OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                    HAS_FIP=$(echo "$OUTPUT" | jq -r --arg ip "$FLOATINGIP" '
                      .[]?
                      | select(."Floating IP Address" == $ip)
                      | ."Floating IP Address"
                    ' | head -n1)
                    if [[ "$HAS_FIP" == "$FLOATINGIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: floating IP $FLOATINGIP not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "secgroup_name_ok" ]]; then
                    SG_NAME="scg-quiz002-1-kelompokx-sijax"
                    OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: security group not found"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-1" && "$KEY" == "secgroup_rules_ok" ]]; then
                    OUTPUT=$(openstack security group rule list scg-quiz002-1-kelompokx-sijax -f json 2>/dev/null || echo "[]")
                    HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "icmp"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_SSH=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "22:22"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_HTTP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "80:80"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_HTTPS=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "443:443"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" && -n "$HAS_HTTP" && -n "$HAS_HTTPS" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: missing rules (ICMP=$HAS_ICMP, SSH=$HAS_SSH, HTTP=$HAS_HTTP, HTTPS=$HAS_HTTPS)"
                    fi

                # ===================== QUIZ 002-2 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "intnet_deleted" ]]; then
                    NET_NAME="intnet-quiz002-1-kelompokx-sijax"
                    OUTPUT=$(openstack network list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$NET_NAME"; then
                        DATA["$KEY"]="Error: internal network masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "intsubnet_deleted" ]]; then
                    SUBNET_NAME="intsubnet-quiz002-1-kelompokx-sijax"
                    OUTPUT=$(openstack subnet list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$SUBNET_NAME"; then
                        DATA["$KEY"]="Error: internal subnet masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "router_iface_unset" ]]; then
                    OUTPUT=$(openstack router show ro-horizon-kelompokx-sijax -f json 2>/dev/null || echo "")
                    # Cek apakah ada interface yang menghubung ke intsubnet-quiz002-1-kelompokx-sijax
                    QUIZ_SUBNET_ID=$(openstack subnet show intsubnet-quiz002-1-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')
                    SUBNETS=$(echo "$OUTPUT" | jq -r '.interfaces_info[].subnet_id // empty')
                    if [[ -z "$QUIZ_SUBNET_ID" ]]; then
                        # Subnet sudah dihapus, berarti interface pasti tidak ada
                        DATA["$KEY"]="OK"
                    elif echo "$SUBNETS" | grep -Fxq "$QUIZ_SUBNET_ID"; then
                        # Interface masih ada
                        DATA["$KEY"]="Error: router masih connected ke quiz subnet"
                    else
                        # Interface sudah dilepas
                        DATA["$KEY"]="OK"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "floating_ip_deleted" ]]; then
                    OUTPUT=$(openstack floating ip list -f json 2>/dev/null || echo "[]")
                    # Cek apakah floating IP dari quiz masih ada
                    HAS_FIP=$(echo "$OUTPUT" | jq -r --arg ip "$FLOATINGIP" '.[] | select(.Floating_IP_Address==$ip) | .Floating_IP_Address' | head -n1)
                    if [[ -z "$HAS_FIP" || "$HAS_FIP" != "$FLOATINGIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: floating IP $FLOATINGIP masih ada"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-002-2" && "$KEY" == "secgroup_deleted" ]]; then
                    SG_NAME="scg-quiz002-1-kelompokx-sijax"
                    OUTPUT=$(openstack security group list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$SG_NAME"; then
                        DATA["$KEY"]="Error: security group masih ada"
                    else
                        DATA["$KEY"]="OK"
                    fi

                # ===================== OSADM-QUIZ-003-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_server_ok" ]]; then
                    NAME="2048-quiz003-1-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")

                    FLAVOR=$(echo "$OUTPUT" | jq -r '.flavor.original_name // empty')
                    IMAGE=$(echo "$OUTPUT"  | jq -r '.image // empty')
                    KEYNAME=$(echo "$OUTPUT" | jq -r '.key_name // empty')
                    SG_LIST=$(echo "$OUTPUT" | jq -r '.security_groups[].name // empty' | sort | tr '\n' ' ')
                    NETS=$(echo "$OUTPUT" | jq -r '.addresses | keys[]? // empty' | tr '\n' ' ')

                    EXP_FLAVOR="quiz003-1-medium-kelompokx-sijax"
                    EXP_IMAGE="ubuntu24.04-quiz003-1-kelompokx-sijax"
                    EXP_KEY="key-quiz003-1-kelompokx-sijax"
                    EXP_SG="sg-quiz003-1-kelompokx-sijax"
                    EXP_NET="net-quiz003-1-kelompokx-sijax"

                    if [[ "$FLAVOR" == "$EXP_FLAVOR" && "$IMAGE" == *"$EXP_IMAGE"* && \
                          "$KEYNAME" == "$EXP_KEY" && "$SG_LIST" == *"$EXP_SG"* && \
                          "$NETS" == *"$EXP_NET"* ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: server spec mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_net_ok" ]]; then
                    OUTPUT=$(openstack subnet show subnet-quiz003-1-kelompokx-sijax -f json 2>/dev/null || echo "")
                    CIDR=$(echo "$OUTPUT" | jq -r '.cidr // empty')
                    GATEWAY=$(echo "$OUTPUT" | jq -r '.gateway_ip // empty')
                    POOL_START=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].start // empty')
                    POOL_END=$(echo "$OUTPUT" | jq -r '.allocation_pools[0].end // empty')
                    DNS=$(echo "$OUTPUT" | jq -r '.dns_nameservers[0] // empty')

                    EXPECTED_CIDR="172.19.${X_INT}.0/24"
                    EXPECTED_GW="172.19.${X_INT}.1"
                    EXPECTED_START="172.19.${X_INT}.35"
                    EXPECTED_END="172.19.${X_INT}.75"
                    EXPECTED_DNS="8.8.8.8"

                    if [[ "$CIDR" == "$EXPECTED_CIDR" && "$GATEWAY" == "$EXPECTED_GW" && \
                          "$POOL_START" == "$EXPECTED_START" && "$POOL_END" == "$EXPECTED_END" && \
                          "$DNS" == "$EXPECTED_DNS" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: subnet spec mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_port_ok" ]]; then
                    OUTPUT=$(openstack port show port-quiz003-1-kelompokx-sijax -f json 2>/dev/null || echo "")
                    FIXED_IP=$(echo "$OUTPUT" | jq -r '.fixed_ips[0].ip_address // empty')
                    SUBNET_ID=$(echo "$OUTPUT" | jq -r '.fixed_ips[0].subnet_id // empty')
                    DEVICE_ID=$(echo "$OUTPUT" | jq -r '.device_id // empty')

                    EXPECTED_IP="172.19.${X_INT}.47"
                    EXPECTED_SUBNET_ID=$(openstack subnet show subnet-quiz003-1-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')
                    SERVER_ID=$(openstack server show 2048-quiz003-1-kelompokx-sijax -f json 2>/dev/null | jq -r '.id // empty')

                    if [[ "$FIXED_IP" == "$EXPECTED_IP" && \
                          "$SUBNET_ID" == "$EXPECTED_SUBNET_ID" && \
                          "$DEVICE_ID" == "$SERVER_ID" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: port or fixed IP mismatch"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_sg_ok" ]]; then
                    OUTPUT=$(openstack security group rule list sg-quiz003-1-kelompokx-sijax -f json 2>/dev/null || echo "[]")
                    HAS_ICMP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "icmp" and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_SSH=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "22:22"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)
                    HAS_HTTP=$(echo "$OUTPUT" | jq -r '
                      .[]?
                      | select(."IP Protocol" == "tcp"
                               and ."Port Range" == "80:80"
                               and .Direction == "ingress")
                      | .ID
                    ' | head -n1)

                    if [[ -n "$HAS_ICMP" && -n "$HAS_SSH" && -n "$HAS_HTTP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: missing ICMP/SSH/HTTP rule"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_fip_ok" ]]; then
                    NAME="2048-quiz003-1-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    HAS_FIP=$(echo "$OUTPUT" | jq -r '
                      .addresses
                      | ..?
                      | strings
                      | select(test("^172\\.20\\.10\\."))
                    ' | sort | head -n1)

                    if [[ "$HAS_FIP" == "$FLOATINGIP" ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: wrong or missing floating IP (expected '"$FLOATINGIP"', got '${HAS_FIP:-none}')"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-003-1" && "$KEY" == "quiz3_nginx_2048_ok" ]]; then
                    NAME="2048-quiz003-1-kelompokx-sijax"
                    OUTPUT=$(openstack server show "$NAME" -f json 2>/dev/null || echo "")
                    FIP=$(echo "$OUTPUT" | jq -r '
                      .addresses
                      | ..?
                      | strings
                      | select(test("^172\\.20\\.10\\."))
                    ' | sort | head -n1)

                    if [[ -z "$FIP" ]]; then
                        DATA["$KEY"]="Error: no floating IP to test"
                    else
                        HTTP_OUT=$(curl -m 5 -s "http://$FIP/" || true)
                        # Cek minimal ada teks '2048' di halaman (game 2048)
                        if echo "$HTTP_OUT" | grep -qi "2048"; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: 2048 app not accessible on $FIP"
                        fi
                    fi

                # ===================== OSADM-QUIZ-006-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "stack_name_ok" ]]; then
                    LOCAL_SUFFIX="kelompokx-sijax"
                    STACK_NAME="instance-stack-${LOCAL_SUFFIX}"
                    OUTPUT=$(openstack stack list -f value -c "Stack Name" -c "Stack Status" 2>/dev/null)
                    if echo "$OUTPUT" | awk -v s="$STACK_NAME" '$1==s && $2 ~ /_COMPLETE$/ {found=1} END {exit found?0:1}'; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: stack $STACK_NAME not COMPLETE"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "stack_events_scale_ok_quiz" ]]; then
                    LOCAL_SUFFIX="kelompokx-sijax"
                    STACK_NAME="instance-stack-${LOCAL_SUFFIX}"
                    OUTPUT=$(openstack stack event list "$STACK_NAME" 2>/dev/null)
                    OUT_COUNT=$(echo "$OUTPUT" | grep "scale_out_policy" | grep -c "SIGNAL_COMPLETE")
                    IN_COUNT=$(echo "$OUTPUT"  | grep "scale_in_policy"  | grep -c "SIGNAL_COMPLETE")
                    if [[ "$OUT_COUNT" -ge 1 && "$IN_COUNT" -ge 1 ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: need >=1 scale out and >=1 scale in SIGNAL_COMPLETE (got out=$OUT_COUNT, in=$IN_COUNT)"
                    fi

                elif [[ "$LAB_ID" == "OSADM-QUIZ-006-1" && "$KEY" == "autoscaling_quiz_config_ok" ]]; then
                    FILE=""
                    for CAND in "./autoscaling.yaml" "$HOME/autoscaling.yaml" "/opt/grading/autoscaling.yaml"; do
                        if [[ -f "$CAND" ]]; then
                            FILE="$CAND"
                            break
                        fi
                    done

                    if [[ -z "$FILE" ]]; then
                        DATA["$KEY"]="Error: autoscaling.yaml not found in ./, $HOME, or /opt/grading"
                    else
                        if grep -q "min_size:[[:space:]]*1" "$FILE" \
                           && grep -q "max_size:[[:space:]]*2" "$FILE" \
                           && grep -q "desired_capacity:[[:space:]]*1" "$FILE" \
                           && grep -q "threshold:[[:space:]]*150000000000" "$FILE" \
                           && grep -q "threshold:[[:space:]]*45000000000" "$FILE"; then
                            DATA["$KEY"]="OK"
                        else
                            DATA["$KEY"]="Error: autoscaling quiz values not found (min=1,max=2,desired=1,thresholds=150000000000/45000000000)"
                        fi
                    fi

                # ===================== OSADM-QUIZ-007-1 =====================
                elif [[ "$LAB_ID" == "OSADM-QUIZ-007-1" && "$KEY" == "http_backend2_only_fip_ok" ]]; then
                    FIP="172.20.10.63"
                    OK=1
                    for i in {1..4}; do
                        OUT=$(curl -s "http://${FIP}/" || true)
                        echo "$OUT"
                        if ! echo "$OUT" | grep -q "Hello from Backend2"; then
                            OK=0
                        fi
                    done

                    if [[ "$OK" -eq 1 ]]; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: HTTP response via FIP not consistently from Backend2"
                    fi



                # ===================== OSADM-001-2 / 001-3 existing =====================
                elif [[ "$KEY" == "image_name_ok" ]]; then
                    OUTPUT=$(openstack image list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$EXPECTED_IMAGE_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: image name not match"
                    fi

                elif [[ "$KEY" == "flavor_name_ok" ]]; then
                    OUTPUT=$(openstack flavor list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$EXPECTED_FLAVOR_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: flavor name not match"
                    fi

                elif [[ "$KEY" == "flavor_spec_ok" ]]; then
                    OUTPUT=$(openstack flavor show "$EXPECTED_FLAVOR_NAME" -f json 2>/dev/null || echo "")
                    RAM=$(echo "$OUTPUT"   | jq -r '.ram // empty')
                    DISK=$(echo "$OUTPUT"  | jq -r '.disk // empty')
                    VCPUS=$(echo "$OUTPUT" | jq -r '.vcpus // empty')
                    if [[ "$LAB_ID" == "OSADM-001-2" ]]; then
                        [[ "$RAM" == "512" && "$DISK" == "4" && "$VCPUS" == "1" ]] && DATA["$KEY"]="OK" || DATA["$KEY"]="Error: flavor spec mismatch"
                    else
                        [[ "$RAM" == "1024" && "$DISK" == "4" && "$VCPUS" == "1" ]] && DATA["$KEY"]="OK" || DATA["$KEY"]="Error: flavor spec mismatch"
                    fi

                elif [[ "$KEY" == "keypair_name_ok" ]]; then
                    OUTPUT=$(openstack keypair list -f value -c Name 2>/dev/null)
                    if echo "$OUTPUT" | grep -Fxq "$EXPECTED_KEYPAIR_NAME"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: keypair name not match"
                    fi

                else
                    # fallback generic command untuk lab lain
                    CMD=$(echo "$CMD_TEMPLATE" | sed \
                        -e "s/PLACEHOLDER/${EXPECTED_SUFFIX}/g" \
                        -e "s/FIP_PLACEHOLDER/${FLOATINGIP}/g" \
                        -e "s/X_INT/${X_INT}/g")

                    OUTPUT=$(eval "$CMD" 2>&1)
                    if echo "$OUTPUT" | grep -q "$EXPECTED"; then
                        DATA["$KEY"]="OK"
                    else
                        DATA["$KEY"]="Error: expected '$EXPECTED' not found"
                    fi
                fi
                ;;

            file_content)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                CONTAINS=$(echo "$criterion" | jq -r '.contains')
                echo "Checking file: $FILE_PATH"
                if [[ -f "$FILE_PATH" ]]; then
                    CONTENT=$(cat "$FILE_PATH" 2>/dev/null || echo "")
                    echo "File content: $CONTENT"
                    if [[ "$CONTENT" == *"$CONTAINS"* ]]; then
                        DATA["$KEY"]="contains"
                    else
                        DATA["$KEY"]="Error: Content not found"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            service)
                SERVICE_NAME=$(echo "$criterion" | jq -r '.service')
                if systemctl is-active --quiet "$SERVICE_NAME"; then
                    DATA["$KEY"]="active"
                else
                    DATA["$KEY"]="Error: Service not active"
                fi
                ;;
            directory)
                DIR_PATH=$(echo "$criterion" | jq -r '.path')
                if [[ -d "$DIR_PATH" ]]; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Directory not found"
                fi
                ;;
            config_check)
                FILE_PATH=$(echo "$criterion" | jq -r '.path')
                PARAMETER=$(echo "$criterion" | jq -r '.parameter')
                EXPECTED=$(echo "$criterion" | jq -r '.expected')
                if [[ -f "$FILE_PATH" ]]; then
                    if [[ "$PARAMETER" == "owner" ]]; then
                        OWNER=$(stat -c "%U" "$FILE_PATH")
                        if [[ "$OWNER" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect owner"
                        fi
                    elif [[ "$PARAMETER" == "group" ]]; then
                        GROUP=$(stat -c "%G" "$FILE_PATH")
                        if [[ "$GROUP" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect group"
                        fi
                    elif [[ "$PARAMETER" == "permissions" ]]; then
                        PERM=$(stat -c "%A" "$FILE_PATH")
                        PERM=${PERM:1}
                        if [[ "$PERM" == "$EXPECTED" ]]; then
                            DATA["$KEY"]="correct"
                        else
                            DATA["$KEY"]="Error: Incorrect permissions"
                        fi
                    else
                        DATA["$KEY"]="Error: Invalid parameter"
                    fi
                else
                    DATA["$KEY"]="Error: File not found"
                fi
                ;;
            package)
                PACKAGE_NAME=$(echo "$criterion" | jq -r '.name')
                if dpkg -l | grep -q "^ii  $PACKAGE_NAME "; then
                    DATA["$KEY"]="installed"
                else
                    DATA["$KEY"]="Error: Package not installed"
                fi
                ;;
            user)
                USER_NAME="$KEY"
                if id "$USER_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: User not found"
                fi
                ;;
            group)
                GROUP_NAME=$(echo "$criterion" | jq -r '.name')
                if getent group "$GROUP_NAME" &>/dev/null; then
                    DATA["$KEY"]="exists"
                else
                    DATA["$KEY"]="Error: Group not found"
                fi
                ;;
            *)
                echo "Unsupported criterion type: $TYPE"
                exit 1
                ;;
        esac
    done < <(echo "$SCHEME" | jq -c '.criteria[]')

    CLIENT_DATA=$(jq -n \
        --arg lab_id "$LAB_ID" \
        --arg class_name "$CLASS_NAME" \
        '{
            lab_id: $lab_id,
            class_name: $class_name,
            client_data: {}
        }')

    echo "=== DEBUG CONFIG ==="
    echo "X_INT: $X_INT"
    echo "FL_PREFIX: $FL_PREFIX" 
    echo "ROUTER_IP: $ROUTER_IP"
    echo "FLOATINGIP: $FLOATINGIP"
    echo "===================="


    echo "=== DEBUG DATA for $LAB_ID ==="
    for key in "${!DATA[@]}"; do
        echo "$key => ${DATA[$key]}"
    done
    echo "=============================="

    for key in "${!DATA[@]}"; do
        value="${DATA[$key]}"
        CLIENT_DATA=$(printf '%s\n' "$CLIENT_DATA" | \
            jq --arg k "$key" --arg v "$value" '.client_data[$k] = $v')
    done

    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "$CLIENT_DATA" \
        "$SERVER_URL/grade-lab")

    print_grading_result "$LAB_ID" "$RESPONSE"
}

function list_labs() {
    RESPONSE=$(curl -s -X GET "$SERVER_URL/list-labs")

    LABS=$(echo "$RESPONSE" | jq -r '.labs[] | "\(.lab_id): \(.scheme_path)"')
    if [[ -z "$LABS" ]]; then
        echo "No labs found"
    else
        echo "Available Labs:"
        echo "$LABS"
    fi
}

function print_grading_result() {
    LAB_ID=$1
    RESPONSE=$2

    LOG_DIR="/var/log/gradingctl/labs"
    LOG_TXT_FILE="$LOG_DIR/${LAB_ID}.log"

    sudo mkdir -p "$LOG_DIR"
    sudo chown -R "$USER:$USER" /var/log/gradingctl
    sudo chmod 755 /var/log/gradingctl
    sudo chmod 755 "$LOG_DIR"

    : > "$LOG_TXT_FILE"

    ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error // empty')
    if [[ -n "$ERROR_MSG" ]]; then
        echo -e "${RED}[-] Grading lab -> $LAB_ID${NC}"
        echo -e "${RED}[x] Error: $ERROR_MSG${NC}"
        return
    fi

    FEEDBACK=$(echo "$RESPONSE" | jq -c '.feedback // []')
    SCORE=$(echo "$RESPONSE" | jq -r '.score // 0')
    SCORE_INT=$(printf "%.0f" "$SCORE" 2>/dev/null || echo 0)
    DURATION=$(echo "$RESPONSE" | jq -r '.duration // 0' | awk '{printf("%d\n", ($1+59)/60)}')

    mapfile -t FEEDBACK_LINES < <(echo "$FEEDBACK" | jq -r '.[]')

    for feedback_msg in "${FEEDBACK_LINES[@]}"; do
        if [[ "$feedback_msg" == *": Failed" ]]; then
            NOW=$(date '+%Y-%m-%d %H:%M:%S')
            echo "[$NOW] CASE: ${feedback_msg%: Failed} | ERROR: Failed" >> "$LOG_TXT_FILE"
        fi
    done

    echo -e "${NC}[-] Grading lab -> $LAB_ID${NC}"

    local i=1
    local has_failed=0
    for feedback_msg in "${FEEDBACK_LINES[@]}"; do
        if [[ "$feedback_msg" == *": Failed" ]]; then
            has_failed=1
            case_name="${feedback_msg%: Failed}"
            echo -e "${RED}    => case $i - $case_name: Failed [x]${NC}"
        else
            echo -e "${GREEN}    => case $i - $feedback_msg [âœ“]${NC}"
        fi
        ((i++))
    done

    if [[ "$has_failed" -eq 1 ]]; then
        echo -e "${RED}[x] Oh no! You didn't complete all the tasks yet${NC}"
        echo -e "${YELLOW}[!] Hint: You may check gradingctl fetch-log $LAB_ID${NC}"
        echo -e "${YELLOW}[!] Or open the log file at: $LOG_TXT_FILE${NC}"
    fi

    echo -e "${NC}[-] Time -> $DURATION minutes"
    echo -e "${NC}[-] Score -> $SCORE${NC}"

    if [[ "$SCORE_INT" -eq 100 ]]; then
        echo -e "${GREEN}[âœ“] Congratulations! You've completed the task!${NC}"
    else
        echo -e "${GREEN}[âœ“] Don't worry, we keep your higher score${NC}"
    fi
}

function finish() {
    TOKEN=$(cat ~/.nusactl_token)
    if [[ -z "$TOKEN" ]]; then
        echo -e "${RED}Error: Token not found. Please login first.${NC}"
        exit 1
    fi

    LAB_ID=$1
    if [[ -z "$LAB_ID" ]]; then
        echo -e "${RED}Error: Lab ID is required.${NC}"
        exit 1
    fi

    # Kirim request ke server untuk menghapus lab yang aktif
    RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"lab_id\": \"$LAB_ID\"}" \
        "$SERVER_URL/finish-lab")


    # Kalau respon bukan JSON (mulai dari '<'), jangan di-jq
    if [[ "$RESPONSE" =~ ^\< ]]; then
        echo -e "${RED}Server error saat finish lab. Cek log server.${NC}"
        exit 1
    fi

    ERROR=$(echo "$RESPONSE" | jq -r '.error')
    MESSAGE=$(echo "$RESPONSE" | jq -r '.message')
    echo "RAW: $RESPONSE"

    if [[ "$ERROR" != "null" && -n "$ERROR" ]]; then
        echo -e "${RED}Error: $ERROR${NC}"
        exit 1
    else
        echo -e "${GREEN}$MESSAGE${NC}"
        rm -f "$ACTIVE_LAB_FILE"
    fi

    # ===== FLEXIBLE CLEANUP USER BERDASARKAN SKEMA =====
    # Ambil scheme dari server
    SCHEME_RESP=$(curl -s -X GET -H "Authorization: Bearer $TOKEN" \
        "$SERVER_URL/get-scheme?lab_id=$LAB_ID")

    SCHEME=$(echo "$SCHEME_RESP" | jq -c '.scheme // empty')
    if [[ -z "$SCHEME" || "$SCHEME" == "null" ]]; then
        return
    fi

    # Loop semua criteria yang type=user dan cleanup=true
    while IFS= read -r crit; do
        TYPE=$(echo "$crit" | jq -r '.type')
        CLEANUP=$(echo "$crit" | jq -r '.cleanup // false')
        KEY=$(echo "$crit" | jq -r '.key')

        if [[ "$TYPE" == "user" && "$CLEANUP" == "true" && -n "$KEY" ]]; then
            sudo userdel -r "$KEY" 2>/dev/null || true
        fi
    done < <(echo "$SCHEME" | jq -c '.criteria[]')
}

function logout() {
    if [[ -f ~/.nusactl_token ]]; then
        rm ~/.nusactl_token
        echo -e "${GREEN}Logged out successfully.${NC}"
    else
        echo -e "${YELLOW}No active session found.${NC}"
    fi
}

function fetch_log() {
    LAB_ID=$1
    LOG_FILE="/var/log/gradingctl/labs/${LAB_ID}.log"
    if [[ -f "$LOG_FILE" ]]; then
        cat "$LOG_FILE"
    else
        echo "Log file not found for lab: $LAB_ID"
    fi
}


#function fetch_log() {
#    TOKEN=$(cat ~/.nusactl_token)
#    LAB_ID=$1
#    SERVER_URL="10.10.10.12:5000"
#    RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$SERVER_URL/get-log?lab_id=$LAB_ID")
#    LOG_CONTENT=$(echo "$RESPONSE" | jq -r '.content // .error')
#    echo "$LOG_CONTENT"
#}

function help() {
    echo -e "${BLUE}Usage: gradingctl {command} [options]${NC}"
    echo -e "${BLUE}Commands:${NC}"
    echo -e "  ${GREEN}login${NC}       - Login to the system"
    echo -e "  ${GREEN}register${NC}    - Register a new user"
    echo -e "  ${GREEN}start${NC}       - Start a lab (usage: start <lab_id> [-s|-f])"
    echo -e "  ${GREEN}grade${NC}       - Grade a lab (usage: grade <lab_id>)"
    echo -e "  ${GREEN}finish${NC}      - Finish a lab (usage: finish <lab_id>)"
    echo -e "  ${GREEN}logout${NC}      - Logout from the system"
    echo -e "  ${GREEN}list-labs${NC}   - List all available labs"
    echo -e "  ${GREEN}-h, --help${NC}  - Show this help message"
    echo -e "${BLUE}Options:${NC}"
    echo -e "  ${YELLOW}-s${NC}         - Show simplified scheme when starting a lab"
    echo -e "  ${YELLOW}-f${NC}         - Save scheme to file when starting a lab"
}

case $1 in
    login) login ;;
    register) register ;;
    start) start_lab $2 $3 ;;  # Tambahkan $3 untuk opsi (-s atau -f)
    grade) grade_lab $2 ;;
    finish) finish $2 ;;
    logout) logout ;;
    fetch-log) fetch_log $2 ;;
    list-labs) list_labs ;;
    -h|--help) help ;;
    *) echo "Usage: gradingctl {login|register|start|grade|finish|logout|fetch-log|list-labs|-h|--help}" ;;
esac
